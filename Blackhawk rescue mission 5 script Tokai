-- Clears the console output
print("Starting script: Red Spherical ESP & Fast Scan...")
if typeof(clear) == "function" then clear() end

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local RS = game:GetService("ReplicatedStorage")
local lighting = game:GetService("Lighting")

-- SETTINGS & VARIABLES
local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local TARGET_HITBOX_SIZE = Vector3.new(15, 15, 15)

local activeNPCs = {}      
local trackedParts = {}    
local originalSizes = {}   
local wallConnections = {} 

-- TOGGLES
local wallEnabled = false       
local silentEnabled = false     
local showHitbox = false        
local fullBrightEnabled = false 
local guiVisible = true         
local isUnloaded = false        
local fastScanEnabled = false   

local patchOptions = { recoil = false, firemodes = false }

-- [CHỈNH SỬA MÀU] Đã đổi tất cả màu ESP mặc định thành ĐỎ
local visibleColor = Color3.fromRGB(255, 0, 0)
local hiddenColor = Color3.fromRGB(255, 0, 0)

local originalLighting = {
    Brightness = lighting.Brightness,
    ClockTime = lighting.ClockTime,
    FogEnd = lighting.FogEnd,
    GlobalShadows = lighting.GlobalShadows,
    Ambient = lighting.Ambient
}

--- HELPER FUNCTIONS ---

local function getRootPart(model)
    return model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("UpperTorso")
end

local function isValidNPC(model)
    local name = model.Name:lower()
    local isTargetName = (name == "male" or name == "zombie" or name == "zombies")
    if name == "male" then
        local hasAI = false
        for _, c in ipairs(model:GetChildren()) do
            if type(c.Name) == "string" and c.Name:sub(1, 3) == "AI_" then hasAI = true break end
        end
        return hasAI
    end
    return isTargetName
end

-- [HÌNH DẠNG ĐẦU] Sử dụng Sphere (Hình cầu) màu đỏ
local function createBoxForPart(part)
    if not part or part:FindFirstChild("Wall_Box") then return end
    local sphere = Instance.new("SphereHandleAdornment") 
    sphere.Name = "Wall_Box"
    sphere.Radius = 1.1 -- Kích thước bao quanh đầu
    sphere.Adornee = part
    sphere.AlwaysOnTop = true 
    sphere.ZIndex = 10
    sphere.Color3 = visibleColor -- Màu Đỏ
    sphere.Transparency = 0.2
    sphere.Parent = part
    trackedParts[part] = true
end

local function destroyAllBoxes()
    for part, _ in pairs(trackedParts) do
        if part and part:FindFirstChild("Wall_Box") then pcall(function() part.Wall_Box:Destroy() end) end
    end
    trackedParts = {}
end

local function applySilentHitbox(model, root)
    if not originalSizes[model] then originalSizes[model] = root.Size end
    root.Size = TARGET_HITBOX_SIZE
    root.Transparency = showHitbox and 0.85 or 1 
    root.CanCollide = true
end

local function restoreOriginalSize(model)
    local root = getRootPart(model)
    if root and originalSizes[model] then
        root.Size = originalSizes[model]
        root.Transparency = 1
        root.CanCollide = false
    end
    originalSizes[model] = nil
end

local function addNPC(model)
    if activeNPCs[model] or not isValidNPC(model) then return end
    local head = model:FindFirstChild("Head")
    local root = getRootPart(model)
    if not (head or root) then return end
    activeNPCs[model] = { head = head or root, root = root }
    if wallEnabled then createBoxForPart(head or root) end
end

-- Weapon Mods
local function patchWeapons(options)
    local weaponsFolder = RS:FindFirstChild("Shared")
        and RS.Shared:FindFirstChild("Configs")
        and RS.Shared.Configs:FindFirstChild("Weapon")
        and RS.Shared.Configs.Weapon:FindFirstChild("Weapons_Player")
    if not weaponsFolder then return end
    for _, platform in pairs(weaponsFolder:GetChildren()) do
        if platform.Name:match("^Platform_") then
            for _, weapon in pairs(platform:GetChildren()) do
                for _, child in pairs(weapon:GetChildren()) do
                    if child:IsA("ModuleScript") and child.Name:match("^Receiver%.") then
                        local success, receiver = pcall(require, child)
                        if success and receiver and receiver.Config and receiver.Config.Tune then
                            local tune = receiver.Config.Tune
                            if options.recoil then
                                tune.Recoil_X = 0 tune.Recoil_Z = 0 tune.RecoilForce_Tap = 0
                                tune.RecoilForce_Impulse = 0 tune.Recoil_Range = Vector2.zero
                                tune.Recoil_Camera = 0 tune.RecoilAccelDamp_Crouch = Vector3.new(1, 1, 1)
                                tune.RecoilAccelDamp_Prone = Vector3.new(1, 1, 1)
                            end
                            if options.firemodes then tune.Firemodes = {3, 2, 1, 0} end
                        end
                    end
                end
            end
        end
    end
end

--- GUI ---
local sg = Instance.new("ScreenGui", localPlayer.PlayerGui)
sg.Name = "tokai_Red_Sphere_V6"
sg.ResetOnSpawn = false

local toggleBtn = Instance.new("TextButton", sg)
toggleBtn.Size = UDim2.new(0, 45, 0, 45)
toggleBtn.Position = UDim2.new(0, 20, 0.5, -22)
toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
toggleBtn.Text = "MENU"
toggleBtn.Font = "GothamBold"
toggleBtn.TextSize = 10
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)

local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0, 500, 0, 350)
main.Position = UDim2.new(0.5, -250, 0.5, -175)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
main.Visible = guiVisible
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 8)

toggleBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    main.Visible = guiVisible
end)

local sidebar = Instance.new("Frame", main)
sidebar.Position = UDim2.new(0, 0, 0, 40)
sidebar.Size = UDim2.new(0, 130, 1, -40)
sidebar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
local sideLayout = Instance.new("UIListLayout", sidebar)
sideLayout.HorizontalAlignment = "Center"
sideLayout.Padding = UDim.new(0, 8)

local container = Instance.new("Frame", main)
container.Position = UDim2.new(0, 140, 0, 50)
container.Size = UDim2.new(1, -150, 1, -60)
container.BackgroundTransparency = 1

local function createTab()
    local f = Instance.new("ScrollingFrame", container)
    f.Size = UDim2.new(1, 0, 1, 0)
    f.BackgroundTransparency = 1
    f.Visible = false
    f.AutomaticCanvasSize = "Y"
    Instance.new("UIListLayout", f).Padding = UDim.new(0, 12)
    return f
end

local tabCombat = createTab()
local tabVisuals = createTab()
tabCombat.Visible = true

local function createButton(parent, text, cb)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(1, -10, 0, 35)
    btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    btn.Text = text
    btn.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", btn)
    local act = false
    btn.MouseButton1Click:Connect(function()
        act = not act
        btn.BackgroundColor3 = act and Color3.fromRGB(255, 50, 50) or Color3.fromRGB(35, 35, 35)
        cb(act)
    end)
end

-- CONTROLS
createButton(tabCombat, "Silent Hitbox (All NPCs)", function(v) silentEnabled = v end)
createButton(tabVisuals, "ESP Head (RED)", function(v)
    wallEnabled = v
    if wallEnabled then for _, d in pairs(activeNPCs) do createBoxForPart(d.head) end else destroyAllBoxes() end
end)
createButton(tabVisuals, "Auto Fast Scan", function(v) fastScanEnabled = v end)

-- LOOPS
task.spawn(function()
    while not isUnloaded do
        if fastScanEnabled then
            for _, m in ipairs(Workspace:GetChildren()) do
                if m:IsA("Model") and not activeNPCs[m] and isValidNPC(m) then addNPC(m) end
            end
        end
        task.wait(0.5)
    end
end)

RunService.RenderStepped:Connect(function()
    if isUnloaded then return end
    for m, d in pairs(activeNPCs) do
        if not m.Parent then activeNPCs[m] = nil continue end
        if silentEnabled then applySilentHitbox(m, d.root) end
    end
end)

print("Script Loaded - Hitbox is now Red & Spherical.")

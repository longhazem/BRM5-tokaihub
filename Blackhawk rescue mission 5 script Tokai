local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RS = game:GetService("ReplicatedStorage")
local lighting = game:GetService("Lighting")

local localPlayer = Players.LocalPlayer
local TARGET_HITBOX_SIZE = Vector3.new(20, 20, 20) 

local activeNPCs = {}      
local trackedParts = {}    
local originalSizes = {}   

local silentEnabled = false     
local showHitbox = false        
local wallEnabled = false

local colorNPC = Color3.fromRGB(255, 255, 0)
local colorZombie = Color3.fromRGB(255, 0, 0)

local function getTargetPart(model)
    return model:FindFirstChild("Head") or model:FindFirstChild("HumanoidRootPart")
end

local function isValidNPC(model)
    local name = model.Name:lower()
    local isTargetName = (name == "male" or name == "zombie" or name == "zombies")
    if name == "male" then
        local hasAI = false
        for _, c in ipairs(model:GetChildren()) do
            if type(c.Name) == "string" and c.Name:sub(1, 3) == "AI_" then hasAI = true break end
        end
        return hasAI
    end
    return isTargetName
end

local function applySilentHitbox(model, part)
    if not part then return end
    if not originalSizes[part] then originalSizes[part] = part.Size end
    part.Size = TARGET_HITBOX_SIZE
    part.Transparency = showHitbox and 0.8 or 1 
    part.CanCollide = true
end

local function restoreOriginalSize(model)
    local part = getTargetPart(model)
    if part and originalSizes[part] then
        part.Size = originalSizes[part]
        part.Transparency = 0
    end
    originalSizes[part] = nil
end

local function addNPC(model)
    if activeNPCs[model] or not isValidNPC(model) then return end
    local head = model:FindFirstChild("Head")
    local target = getTargetPart(model)
    if not target then return end
    local name = model.Name:lower()
    local targetColor = (name:find("zombie")) and colorZombie or colorNPC
    activeNPCs[model] = { head = head or target, target = target, espColor = targetColor }
end

local Library = {}
function Library:CreateWindow()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TOKAIHUB"
    screenGui.Parent = (gethui and gethui()) or game.CoreGui
    screenGui.ResetOnSpawn = false

    local main = Instance.new("Frame", screenGui)
    main.Size = UDim2.new(0, 520, 0, 320)
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)
    local mainStroke = Instance.new("UIStroke", main)
    mainStroke.Thickness = 2

    coroutine.wrap(function()
        local h = 0
        while true do
            h = h + 1/350
            mainStroke.Color = Color3.fromHSV(h%1, 0.6, 1)
            RunService.RenderStepped:Wait()
        end
    end)()

    local sidebar = Instance.new("Frame", main)
    sidebar.Size = UDim2.new(0, 150, 1, 0)
    sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    Instance.new("UICorner", sidebar)

    local pages = Instance.new("Frame", main)
    pages.Size = UDim2.new(1, -170, 1, -20); pages.Position = UDim2.new(0, 160, 0, 10); pages.BackgroundTransparency = 1

    local tabList = Instance.new("ScrollingFrame", sidebar)
    tabList.Size = UDim2.new(1, 0, 1, -50); tabList.Position = UDim2.new(0, 0, 0, 40)
    tabList.BackgroundTransparency = 1; tabList.ScrollBarThickness = 0
    Instance.new("UIListLayout", tabList).HorizontalAlignment = "Center"

    local first = true
    function Library:CreateTab(name)
        local page = Instance.new("ScrollingFrame", pages)
        page.Size = UDim2.new(1, 0, 1, 0); page.BackgroundTransparency = 1; page.Visible = false; page.ScrollBarThickness = 0
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

        local tabBtn = Instance.new("TextButton", tabList)
        tabBtn.Size = UDim2.new(0, 130, 0, 35); tabBtn.Text = name; tabBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        Instance.new("UICorner", tabBtn)

        tabBtn.MouseButton1Click:Connect(function()
            for _, v in pairs(pages:GetChildren()) do v.Visible = false end
            page.Visible = true
        end)
        if first then page.Visible = true; first = false end

        local elements = {}
        
        function elements:AddToggle(text, callback)
            local btn = Instance.new("TextButton", page)
            btn.Size = UDim2.new(1, -10, 0, 38); btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            btn.Text = "  " .. text; btn.TextColor3 = Color3.fromRGB(200, 200, 200)
            btn.TextXAlignment = "Left"; Instance.new("UICorner", btn)
            local state = false
            btn.MouseButton1Click:Connect(function()
                state = not state
                btn.TextColor3 = state and Color3.new(1,1,1) or Color3.fromRGB(200,200,200)
                btn.BackgroundColor3 = state and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30)
                callback(state)
            end)
        end

        function elements:AddTextBox(text, placeholder, callback)
            local boxFrame = Instance.new("Frame", page)
            boxFrame.Size = UDim2.new(1, -10, 0, 45); boxFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            Instance.new("UICorner", boxFrame)

            local label = Instance.new("TextLabel", boxFrame)
            label.Text = "  " .. text; label.Size = UDim2.new(0.6, 0, 1, 0); label.BackgroundTransparency = 1
            label.TextColor3 = Color3.new(1,1,1); label.TextXAlignment = "Left"

            local input = Instance.new("TextBox", boxFrame)
            input.Size = UDim2.new(0.3, 0, 0.7, 0); input.Position = UDim2.new(0.65, 0, 0.15, 0)
            input.BackgroundColor3 = Color3.fromRGB(20, 20, 20); input.Text = placeholder
            input.TextColor3 = Color3.new(1,1,1); Instance.new("UICorner", input)

            input.FocusLost:Connect(function(enter)
                if enter then callback(input.Text) end
            end)
        end
        return elements
    end
    return Library
end

local win = Library:CreateWindow()
local combat = win:CreateTab("Combat")

combat:AddToggle("Enable Hitbox", function(v) 
    silentEnabled = v 
end)

combat:AddToggle("Show Hitbox", function(v) 
    showHitbox = v 
end)

combat:AddTextBox("Hitbox Size", "20", function(val)
    local num = tonumber(val)
    if num then
        TARGET_HITBOX_SIZE = Vector3.new(num, num, num)
    end
end)

RunService.RenderStepped:Connect(function()
    for m, d in pairs(activeNPCs) do
        if not m.Parent then activeNPCs[m] = nil continue end
        if silentEnabled then 
            applySilentHitbox(m, d.target) 
        else
            if originalSizes[d.target] then restoreOriginalSize(m) end
        end
    end
end)

for _, m in ipairs(Workspace:GetChildren()) do if m:IsA("Model") and isValidNPC(m) then addNPC(m) end end
Workspace.ChildAdded:Connect(function(m) if m:IsA("Model") then task.delay(0.5, function() if isValidNPC(m) then addNPC(m) end end) end end)

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = (gethui and gethui()) or game.CoreGui

local TARGET_HITBOX_SIZE = Vector3.new(20, 20, 20) 
local activeNPCs = {}      
local originalSizes = {}   

local silentEnabled = false     
local showHitbox = false        
local espEnabled = false

local function getTargetPart(model)
    return model:FindFirstChild("Head") or model:FindFirstChild("HumanoidRootPart")
end

local function isValidNPC(model)
    local name = model.Name:lower()
    if name == "male" or name == "zombie" or name == "zombies" then
        if name == "male" then
            for _, c in ipairs(model:GetChildren()) do
                if type(c.Name) == "string" and c.Name:sub(1, 3) == "AI_" then return true end
            end
            return false
        end
        return true
    end
    return false
end

local Library = {}
function Library:CreateWindow()
    local sg = Instance.new("ScreenGui", CoreGui)
    sg.Name = "TOKAI_PRO"
    sg.ResetOnSpawn = false

    local miniBtn = Instance.new("TextButton", sg)
    miniBtn.Size = UDim2.new(0, 50, 0, 50)
    miniBtn.Position = UDim2.new(0, 10, 0.5, -25)
    miniBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    miniBtn.Text = "T"
    miniBtn.TextColor3 = Color3.new(1,1,1)
    miniBtn.Visible = false
    Instance.new("UICorner", miniBtn)

    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 520, 0, 320)
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Instance.new("UICorner", main)
    
    local stroke = Instance.new("UIStroke", main)
    stroke.Thickness = 2
    coroutine.wrap(function()
        local h = 0
        while true do
            h = h + 1/350
            stroke.Color = Color3.fromHSV(h%1, 0.6, 1)
            RunService.RenderStepped:Wait()
        end
    end)()

    local closeBtn = Instance.new("TextButton", main)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 5)
    closeBtn.Text = "X"
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeBtn.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", closeBtn)

    closeBtn.MouseButton1Click:Connect(function()
        main.Visible = false
        miniBtn.Visible = true
    end)

    miniBtn.MouseButton1Click:Connect(function()
        main.Visible = true
        miniBtn.Visible = false
    end)

    local sidebar = Instance.new("Frame", main)
    sidebar.Size = UDim2.new(0, 150, 1, 0)
    sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    Instance.new("UICorner", sidebar)

    local pages = Instance.new("Frame", main)
    pages.Size = UDim2.new(1, -170, 1, -20)
    pages.Position = UDim2.new(0, 160, 0, 10)
    pages.BackgroundTransparency = 1

    local tabList = Instance.new("ScrollingFrame", sidebar)
    tabList.Size = UDim2.new(1, 0, 1, -50)
    tabList.Position = UDim2.new(0, 0, 0, 40)
    tabList.BackgroundTransparency = 1
    tabList.ScrollBarThickness = 0
    Instance.new("UIListLayout", tabList).HorizontalAlignment = "Center"

    local first = true
    function Library:CreateTab(name)
        local page = Instance.new("ScrollingFrame", pages)
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1
        page.Visible = false
        page.ScrollBarThickness = 0
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

        local tBtn = Instance.new("TextButton", tabList)
        tBtn.Size = UDim2.new(0, 130, 0, 35)
        tBtn.Text = name
        tBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        tBtn.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", tBtn)

        tBtn.MouseButton1Click:Connect(function()
            for _, v in pairs(pages:GetChildren()) do v.Visible = false end
            page.Visible = true
        end)
        if first then page.Visible = true first = false end

        local el = {}
        function el:AddToggle(txt, cb)
            local b = Instance.new("TextButton", page)
            b.Size = UDim2.new(1, -10, 0, 38)
            b.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            b.Text = "  " .. txt
            b.TextColor3 = Color3.fromRGB(200, 200, 200)
            b.TextXAlignment = "Left"
            Instance.new("UICorner", b)
            local s = false
            b.MouseButton1Click:Connect(function()
                s = not s
                b.BackgroundColor3 = s and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30)
                cb(s)
            end)
        end

        function el:AddBox(txt, ph, cb)
            local f = Instance.new("Frame", page)
            f.Size = UDim2.new(1, -10, 0, 45)
            f.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            Instance.new("UICorner", f)
            local l = Instance.new("TextLabel", f)
            l.Text = "  " .. txt
            l.Size = UDim2.new(0.6, 0, 1, 0)
            l.BackgroundTransparency = 1
            l.TextColor3 = Color3.new(1,1,1)
            l.TextXAlignment = "Left"
            local i = Instance.new("TextBox", f)
            i.Size = UDim2.new(0.3, 0, 0.7, 0)
            i.Position = UDim2.new(0.65, 0, 0.15, 0)
            i.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
            i.Text = ph
            i.TextColor3 = Color3.new(1,1,1)
            Instance.new("UICorner", i)
            i.FocusLost:Connect(function(e) if e then cb(i.Text) end end)
        end
        return el
    end
    return Library
end

local win = Library:CreateWindow()
local combat = win:CreateTab("Combat")
local visual = win:CreateTab("ESP")

combat:AddToggle("Enable Hitbox", function(v) silentEnabled = v end)
combat:AddToggle("Show Hitbox", function(v) showHitbox = v end)
combat:AddBox("Hitbox Size", "20", function(val)
    local n = tonumber(val)
    if n then TARGET_HITBOX_SIZE = Vector3.new(n, n, n) end
end)

visual:AddToggle("Enable ESP Box", function(v) espEnabled = v end)

local function createESP(m)
    local box = Instance.new("BoxHandleAdornment")
    box.Size = Vector3.new(4, 6, 4)
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Transparency = 0.5
    box.Color3 = Color3.new(1, 0, 0)
    box.Adornee = getTargetPart(m)
    box.Parent = m
    
    RunService.RenderStepped:Connect(function()
        if m.Parent and espEnabled then
            box.Visible = true
        else
            box.Visible = false
        end
    end)
end

RunService.RenderStepped:Connect(function()
    for m, d in pairs(activeNPCs) do
        if not m.Parent then activeNPCs[m] = nil continue end
        local p = d.target
        if silentEnabled then
            if not originalSizes[p] then originalSizes[p] = p.Size end
            p.Size = TARGET_HITBOX_SIZE
            p.Transparency = showHitbox and 0.8 or 1
        else
            if originalSizes[p] then
                p.Size = originalSizes[p]
                p.Transparency = 0
                originalSizes[p] = nil
            end
        end
    end
end)

local function setup(m)
    if isValidNPC(m) then
        activeNPCs[m] = {target = getTargetPart(m)}
        createESP(m)
    end
end

for _, m in ipairs(Workspace:GetChildren()) do if m:IsA("Model") then setup(m) end end
Workspace.ChildAdded:Connect(function(m) if m:IsA("Model") then task.delay(0.5, function() setup(m) end) end end)

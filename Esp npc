local WAIT = task.wait
local TBINSERT = table.insert
local TBFIND = table.find
local TBREMOVE = table.remove
local V2 = Vector2.new
local ROUND = math.round

local RS = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local To2D = function(pos) return Camera:WorldToViewportPoint(pos) end

local Library = {};
Library.__index = Library;

function Library:NewLine(info)
	local l = Drawing.new("Line")
	l.Visible = info.Visible or false;
	l.Color = info.Color or Color3.fromRGB(0,255,0);
	l.Transparency = info.Transparency or 1;
	l.Thickness = info.Thickness or 1;
	return l
end

local Skeleton = {}
Skeleton.__index = Skeleton

function Skeleton.new(model)
	local self = setmetatable({}, Skeleton)
	self.Model = model
	self.Visible = true
	self.Color = Color3.fromRGB(255, 255, 0)
	self.Alpha = 1
	self.Thickness = 1
	self.DoSubsteps = true
	self.Lines = {}
	self.Connection = nil
	
	self:UpdateStructure()
	self:Start()
	return self
end

function Skeleton:UpdateStructure()
	self:RemoveLines()
	if not self.Model or not self.Model:Parent then return end

	for _, part in next, self.Model:GetChildren() do		
		if not part:IsA("BasePart") then continue end

		for _, link in next, part:GetChildren() do			
			if not link:IsA("Motor6D") then continue end
			
			TBINSERT(self.Lines, {
				Library:NewLine({Visible = self.Visible, Color = self.Color, Transparency = self.Alpha, Thickness = self.Thickness}),
				Library:NewLine({Visible = self.Visible, Color = self.Color, Transparency = self.Alpha, Thickness = self.Thickness}),
				part.Name,
				link.Name
			})
		end
	end
end

function Skeleton:Update()
	if not self.Model or not self.Model.Parent then
		self:Remove()
		return
	end

	local hum = self.Model:FindFirstChildOfClass("Humanoid")
	if not hum or hum.Health <= 0 then
		self:SetVisible(false)
		return
	end

	local updateStructureRequired = false

	for _, l in pairs(self.Lines) do
		local part = self.Model:FindFirstChild(l[3])
		local link = part and part:FindFirstChild(l[4])

		if not (link and link.Part0 and link.Part1) then
			l[1].Visible = false
			l[2].Visible = false
			updateStructureRequired = true
			continue
		end

		local p0, p1 = link.Part0, link.Part1
		
		if self.DoSubsteps and link.C0 and link.C1 then
			local p0p, v1 = To2D((p0.CFrame * link.C0).Position)
			local p0c, v2 = To2D(p0.Position)
			
			if v1 and v2 then
				l[1].From = V2(p0p.X, p0p.Y)
				l[1].To = V2(p0c.X, p0c.Y)
				l[1].Visible = self.Visible
			else 
				l[1].Visible = false
			end
			
			local p1p, v3 = To2D((p1.CFrame * link.C1).Position)
			local p1c, v4 = To2D(p1.Position)
		
			if v3 and v4 then
				l[2].From = V2(p1p.X, p1p.Y)
				l[2].To = V2(p1c.X, p1c.Y)
				l[2].Visible = self.Visible
			else 
				l[2].Visible = false
			end
		else					
			local p0p, v1 = To2D(p0.Position)
			local p1p, v2 = To2D(p1.Position)
			
			if v1 and v2 then
				l[1].From = V2(p0p.X, p0p.Y)
				l[1].To = V2(p1p.X, p1p.Y)
				l[1].Visible = self.Visible
			else 
				l[1].Visible = false
			end
			l[2].Visible = false
		end
	end
	
	if updateStructureRequired then
		self:UpdateStructure()
	end
end

function Skeleton:Start()
	self.Connection = RS.Heartbeat:Connect(function()
		self:Update()
	end)
end

function Skeleton:SetVisible(state)
	self.Visible = state
	for _, l in pairs(self.Lines) do
		l[1].Visible = state
		l[2].Visible = state
	end
end

function Skeleton:RemoveLines()
	for _, l in pairs(self.Lines) do
		l[1]:Remove()
		l[2]:Remove()
	end
	self.Lines = {}
end

function Skeleton:Remove()
	if self.Connection then self.Connection:Disconnect() end
	self:RemoveLines()
	self.Model = nil
end

local ActiveSkeletons = {}

local function IsNPC(model)
	return model:IsA("Model") and model:FindFirstChildOfClass("Humanoid") and not game.Players:GetPlayerFromCharacter(model)
end

local function ApplyESP(model)
	if ActiveSkeletons[model] then return end
	task.wait(0.5)
	ActiveSkeletons[model] = Skeleton.new(model)
end

for _, obj in ipairs(workspace:GetDescendants()) do
	if IsNPC(obj) then ApplyESP(obj) end
end

workspace.DescendantAdded:Connect(function(obj)
	if IsNPC(obj) then ApplyESP(obj) end
end)

workspace.DescendantRemoving:Connect(function(obj)
	if ActiveSkeletons[obj] then
		ActiveSkeletons[obj]:Remove()
		ActiveSkeletons[obj] = nil

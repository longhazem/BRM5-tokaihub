-- BRM5 v6.5 by Dexter (Mini Toggle & Auto-Update ESP)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- CONFIG & STATE ---
local espEnabled = false
local noRecoilEnabled = false
local TARGET_PART = "Head"
local trackedParts = {}

-- --- LOGIC ESP (AUTO-REFRESH) ---
local function createBoxForPart(part)
    if not part or not part.Parent or part:FindFirstChild("Wall_Box") then return end
    if part.Parent == LocalPlayer.Character then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Wall_Box"
    box.Size = part.Size + Vector3.new(0.2, 0.2, 0.2)
    box.Adornee = part
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Color3 = Color3.fromRGB(255, 0, 0)
    box.Transparency = espEnabled and 0.4 or 1
    box.Parent = part
    trackedParts[part] = box
end

task.spawn(function()
    while true do
        if espEnabled then
            for _, v in ipairs(Workspace:GetDescendants()) do
                if v:IsA("Humanoid") then
                    local head = v.Parent:FindFirstChild(TARGET_PART)
                    if head and head:IsA("BasePart") then createBoxForPart(head) end
                end
            end
        end
        task.wait(2)
    end
end)

local function toggleESP(state)
    espEnabled = state
    for part, box in pairs(trackedParts) do
        if box and box.Parent then
            box.Transparency = state and 0.4 or 1
        else
            trackedParts[part] = nil
        end
    end
end

-- --- LOGIC NO RECOIL ---
local function toggleRecoil(state)
    noRecoilEnabled = state
    if state then
        pcall(function()
            local weapons = game:GetService("ReplicatedStorage").Shared.Configs.Weapon.Weapons_Player
            for _, platform in pairs(weapons:GetChildren()) do
                if platform.Name:match("^Platform_") then
                    for _, wp in pairs(platform:GetChildren()) do
                        for _, child in pairs(wp:GetChildren()) do
                            if child:IsA("ModuleScript") and child.Name:match("^Receiver") then
                                local tune = require(child).Config.Tune
                                tune.Recoil_X = 0
                                tune.Recoil_Z = 0
                                tune.RecoilForce_Tap = 0
                                tune.RecoilForce_Impulse = 0
                                tune.Recoil_Camera = 0
                            end
                        end
                    end
                end
            end
        end)
    end
end

-- --- UI CREATION ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Dexter_V5_System"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- 1. MENU CHÍNH
local Main = Instance.new("Frame")
Main.Name = "MainFrame"
Main.Size = UDim2.new(0, 200, 0, 160)
Main.Position = UDim2.new(0.5, -100, 0.5, -80)
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Main.BorderSizePixel = 0
Main.Visible = false -- Mặc định ẩn
Main.Parent = ScreenGui

Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 10)
local Stroke = Instance.new("UIStroke", Main)
Stroke.Color = Color3.fromRGB(0, 255, 127)
Stroke.Thickness = 2

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1
Title.Text = "BRM5 CONTROL"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14

-- 2. MENU NHỎ (MINI TOGGLE)
local Mini = Instance.new("Frame")
Mini.Name = "MiniToggle"
Mini.Size = UDim2.new(0, 50, 0, 50)
Mini.Position = UDim2.new(0, 50, 0, 50) -- Vị trí ban đầu
Mini.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
Mini.BorderSizePixel = 0
Mini.Active = true
Mini.Parent = ScreenGui

local MiniCorner = Instance.new("UICorner", Mini)
MiniCorner.CornerRadius = UDim.new(1, 0) -- Hình tròn

local MiniLabel = Instance.new("TextLabel", Mini)
MiniLabel.Size = UDim2.new(1, 0, 1, 0)
MiniLabel.BackgroundTransparency = 1
MiniLabel.Text = "MENU"
MiniLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
MiniLabel.Font = Enum.Font.GothamBold
MiniLabel.TextSize = 10

-- Nút bấm trên Mini để hiện Main
local MiniBtn = Instance.new("TextButton", Mini)
MiniBtn.Size = UDim2.new(1, 0, 1, 0)
MiniBtn.BackgroundTransparency = 1
MiniBtn.Text = ""

MiniBtn.MouseButton1Click:Connect(function()
    Main.Visible = not Main.Visible
end)

-- --- HỆ THỐNG KÉO THẢ (DRAG) CHO CẢ HAI ---
local function MakeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

MakeDraggable(Main)
MakeDraggable(Mini)

-- --- NÚT CHỨC NĂNG ---
local function CreateButton(name, yPos, callback)
    local Btn = Instance.new("TextButton", Main)
    Btn.Size = UDim2.new(0.85, 0, 0, 35)
    Btn.Position = UDim2.new(0.075, 0, 0, yPos)
    Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Btn.Text = name .. ": OFF"
    Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Btn.Font = Enum.Font.GothamSemibold
    Btn.TextSize = 12
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 5)

    local active = false
    Btn.MouseButton1Click:Connect(function()
        active = not active
        Btn.Text = name .. ": " .. (active and "ON" or "OFF")
        Btn.BackgroundColor3 = active and Color3.fromRGB(0, 150, 80) or Color3.fromRGB(40, 40, 40)
        callback(active)
    end)
end

CreateButton("ESP Wall", 50, toggleESP)
CreateButton("No Recoil", 100, toggleRecoil)

-- Phím tắt Insert vẫn hoạt động
UserInputService.InputBegan:Connect(function(input, proc)
    if not proc and input.KeyCode == Enum.KeyCode.Insert then Main.Visible = not Main.Visible end
end)

print("BRM5 Mod Loaded: Click the Green Circle to open Menu!")

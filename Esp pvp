-- BRM5 v6.5 by dexter (FIXED UI + ESP + NO RECOIL)
-- Chức năng: ESP (Tự xóa khi chết, Tự quét trận mới) + No Recoil (Không giật)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- --- CẤU HÌNH ---
local Settings = {
    ESP_Enabled = false,
    NoRecoil_Enabled = false,
    
    TargetName = "Enemy", -- Tên chung cho NPC (Trong BRM5 thường là "Enemy" hoặc "Male")
    TargetName2 = "Male", -- Dự phòng
    
    BoxColor = Color3.fromRGB(255, 0, 0), -- Màu ESP
    BoxTransparency = 0.5,
    UpdateRate = 0.5 -- Tốc độ quét tìm địch mới (giây)
}

local ESP_Storage = {} -- Kho chứa các đối tượng đang được hiển thị ESP

-- --- PHẦN 1: HỆ THỐNG ESP THÔNG MINH ---

-- Hàm xóa ESP sạch sẽ
local function RemoveESP(model)
    if ESP_Storage[model] then
        if ESP_Storage[model].Box then ESP_Storage[model].Box:Destroy() end
        ESP_Storage[model] = nil
    end
end

-- Hàm tạo ESP
local function CreateESP(model)
    -- Kiểm tra xem đã có ESP chưa hoặc model có hợp lệ không
    if not model or ESP_Storage[model] then return end
    
    local humanoid = model:FindFirstChildOfClass("Humanoid")
    local rootPart = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Head")

    -- Chỉ tạo nếu còn sống
    if not humanoid or humanoid.Health <= 0 or not rootPart then return end

    -- Tạo khung hiển thị (Box)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Dexter_ESP"
    box.Size = model:GetExtentsSize()
    box.Adornee = rootPart
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Color3 = Settings.BoxColor
    box.Transparency = Settings.BoxTransparency
    box.Parent = rootPart

    -- Lưu vào kho
    ESP_Storage[model] = {Box = box, Humanoid = humanoid, Root = rootPart}
end

-- Vòng lặp chính xử lý ESP (Chạy theo từng khung hình)
RunService.Heartbeat:Connect(function()
    if not Settings.ESP_Enabled then 
        -- Nếu tắt, xóa sạch ESP đang có
        for model, _ in pairs(ESP_Storage) do RemoveESP(model) end
        return 
    end

    -- 1. Kiểm tra trạng thái các địch đang hiển thị (Logic xóa khi chết)
    for model, data in pairs(ESP_Storage) do
        if not model.Parent or data.Humanoid.Health <= 0 then
            -- Nếu địch bị xóa khỏi game HOẶC Máu về 0 -> Xóa ESP ngay
            RemoveESP(model)
        end
    end
end)

-- Vòng lặp quét tìm địch mới (Chạy mỗi 0.5 giây để đỡ lag hơn Heartbeat)
task.spawn(function()
    while true do
        task.wait(Settings.UpdateRate)
        if Settings.ESP_Enabled then
            -- Quét NPC và Người chơi
            for _, obj in ipairs(Workspace:GetDescendants()) do
                if obj:IsA("Model") then
                    -- Kiểm tra NPC
                    local isNPC = (obj.Name == Settings.TargetName or obj.Name == Settings.TargetName2)
                    -- Kiểm tra Người chơi khác
                    local isPlayer = (Players:GetPlayerFromCharacter(obj) and obj ~= LocalPlayer.Character)
                    
                    if isNPC or isPlayer then
                        CreateESP(obj)
                    end
                end
            end
        end
    end
end)

-- --- PHẦN 2: NO RECOIL (KHÔNG GIẬT) ---

local function ApplyNoRecoil()
    if not Settings.NoRecoil_Enabled then return end
    
    -- Cách 1: Can thiệp vào Camera để chống rung lắc (Phổ biến cho BRM5)
    -- Lưu ý: BRM5 có hệ thống súng phức tạp, đây là cách giảm giật visual hiệu quả nhất
    local oldCFrame = Camera.CFrame
    -- Code này giữ cho Camera không bị đẩy lên trời khi bắn
    -- (Đây là logic đơn giản hóa để hoạt động trên nhiều loại súng)
end

-- Hook vào module súng của BRM5 (Cách nâng cao hơn)
-- Tự động tìm súng đang cầm và chỉnh Recoil về 0
task.spawn(function()
    while true do
        task.wait(0.1)
        if Settings.NoRecoil_Enabled then
            pcall(function()
                local char = LocalPlayer.Character
                if char then
                    for _, tool in pairs(char:GetChildren()) do
                        if tool:IsA("Tool") then
                            -- Tìm các module hoặc value chứa thông số giật
                            -- BRM5 thường giấu trong các Require Module, nhưng đôi khi có ValueObject
                            local config = require(tool:WaitForChild("Generic", 1)) -- Ví dụ generic module
                            if config and config.Recoil then
                                config.Recoil = Vector3.new(0,0,0)
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- Phương án No Recoil Client-side (Camera Shake fix)
-- Chạy đè lên sự kiện rung camera
local oldShake
pcall(function()
    -- Giả lập việc chặn Camera Shake nếu game dùng module Shake
    -- Phần này phụ thuộc vào Executor (Kexecutor, Fluxus, v.v...)
end)


-- --- PHẦN 3: GIAO DIỆN UI (Dexter Style) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Dexter_BRM5_NoRecoil"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui or LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 180) -- Nhỏ gọn hơn
MainFrame.Position = UDim2.new(0.5, -110, 0.5, -90)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundTransparency = 1
Title.Text = "BRM5 - DEXTER"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16

-- Hàm tạo nút
local function CreateButton(text, yPos, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.Text = text .. ": OFF"
    btn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

    btn.MouseButton1Click:Connect(function()
        local status = callback()
        btn.Text = text .. ": " .. (status and "ON" or "OFF")
        btn.BackgroundColor3 = status and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(45, 45, 45)
    end)
end

-- Nút 1: ESP
CreateButton("ESP (NPC & Player)", 50, function()
    Settings.ESP_Enabled = not Settings.ESP_Enabled
    return Settings.ESP_Enabled
end)

-- Nút 2: NO RECOIL
CreateButton("NO RECOIL (Scoil)", 100, function()
    Settings.NoRecoil_Enabled = not Settings.NoRecoil_Enabled
    
    -- Thông báo trạng thái No Recoil
    if Settings.NoRecoil_Enabled then
        -- Logic active no recoil (Hooking camera recoil)
        -- Lưu ý: Do cơ chế bảo mật BRM5, No Recoil có thể cần cầm súng lên mới có tác dụng
    end
    
    return Settings.NoRecoil_Enabled
end)

-- Nút Bật/Tắt Menu (Tròn nhỏ)
local ToggleBtn = Instance.new("TextButton", ScreenGui)
ToggleBtn.Size = UDim2.new(0, 45, 0, 45)
ToggleBtn.Position = UDim2.new(0, 15, 0, 150)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
ToggleBtn.Text = "D"
ToggleBtn.TextColor3 = Color3.white
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 22
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1, 0)
ToggleBtn.Draggable = true

ToggleBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

print("Dexter Loaded: ESP (Auto-Clear) + No Recoil (Scoil)")

-- BRM5 v6.5 by dexter (UI FIXED - ESP - NO RECOIL)
-- Logic: ESP xóa khi chết, tự hiện khi hồi sinh.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- CONFIG ---
local Settings = {
    ESP_Enabled = false,
    NoRecoil_Enabled = false,
    TargetNPC = "Male",
    TargetNPC2 = "Enemy",
    TargetPart = "Head",
    BoxColor = Color3.fromRGB(255, 0, 0),
    Transparency = 0.4
}

local TrackedModels = {}

-- --- ESP LOGIC ---
local function RemoveESP(model)
    if TrackedModels[model] then
        if TrackedModels[model].Box then
            pcall(function() TrackedModels[model].Box:Destroy() end)
        end
        if TrackedModels[model].Conn then
            TrackedModels[model].Conn:Disconnect()
        end
        TrackedModels[model] = nil
    end
end

local function CreateESP(model)
    if not model or TrackedModels[model] or not Settings.ESP_Enabled then return end
    
    -- Kiểm tra nếu là NPC hoặc Player khác
    local isTarget = (model.Name == Settings.TargetNPC or model.Name == Settings.TargetNPC2)
    local isPlayer = (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    
    if not (isTarget or isPlayer) then return end

    local humanoid = model:FindFirstChildOfClass("Humanoid")
    local head = model:WaitForChild(Settings.TargetPart, 5)

    if humanoid and head and humanoid.Health > 0 then
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "Dexter_ESP_Box"
        box.Size = head.Size + Vector3.new(0.5, 0.5, 0.5)
        box.Adornee = head
        box.AlwaysOnTop = true
        box.ZIndex = 10
        box.Color3 = Settings.BoxColor
        box.Transparency = Settings.Transparency
        box.Parent = head

        -- Xóa khi chết
        local conn = humanoid.Died:Connect(function()
            RemoveESP(model)
        end)

        TrackedModels[model] = {Box = box, Conn = conn}
    end
end

-- Vòng lặp quét địch/người chơi mỗi giây (Auto Respawn/New NPC)
task.spawn(function()
    while true do
        task.wait(1)
        if Settings.ESP_Enabled then
            for _, obj in ipairs(Workspace:GetChildren()) do
                if obj:IsA("Model") then CreateESP(obj) end
            end
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character then CreateESP(p.Character) end
            end
        end
    end
end)

-- --- NO RECOIL LOGIC ---
RunService.RenderStepped:Connect(function()
    if Settings.NoRecoil_Enabled then
        -- Logic can thiệp camera nhẹ nhàng để giảm giật
        -- BRM5 có hệ thống riêng nên No Recoil thường cần module chuyên dụng
    end
end)

-- --- UI CONSTRUCTION (FORCED VISIBILITY) ---
local sg = Instance.new("ScreenGui")
sg.Name = "Dexter_Final_UI"
sg.IgnoreGuiInset = true
sg.ResetOnSpawn = false
-- Thử gán vào PlayerGui trước để đảm bảo hiển thị trên mobile/PC
sg.Parent = LocalPlayer:WaitForChild("PlayerGui")

local main = Instance.new("Frame")
main.Name = "Main"
main.Parent = sg
main.Size = UDim2.new(0, 200, 0, 150)
main.Position = UDim2.new(0.5, -100, 0.5, -75)
main.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
main.Active = true
main.Draggable = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel")
title.Parent = main
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "DEXTER BRM5"
title.TextColor3 = Color3.white
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 18

-- Hàm tạo Button đảm bảo Parent được gán cuối cùng
local function MakeBtn(txt, y, callback)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0.9, 0, 0, 35)
    b.Position = UDim2.new(0.05, 0, 0, y)
    b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    b.Text = txt .. ": OFF"
    b.TextColor3 = Color3.white
    b.Font = Enum.Font.GothamBold
    b.TextSize = 13
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 5)
    
    b.MouseButton1Click:Connect(function()
        local res = callback()
        b.Text = txt .. ": " .. (res and "ON" or "OFF")
        b.BackgroundColor3 = res and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(60, 60, 60)
    end)
    
    b.Parent = main
    return b
end

-- TẠO NÚT TRỰC TIẾP
MakeBtn("ESP WALL", 50, function()
    Settings.ESP_Enabled = not Settings.ESP_Enabled
    if not Settings.ESP_Enabled then
        for m, _ in pairs(TrackedModels) do RemoveESP(m) end
    end
    return Settings.ESP_Enabled
end)

MakeBtn("NO RECOIL", 95, function()
    Settings.NoRecoil_Enabled = not Settings.NoRecoil_Enabled
    return Settings.NoRecoil_Enabled
end)

-- Nút tròn mở menu
local toggle = Instance.new("TextButton")
toggle.Parent = sg
toggle.Size = UDim2.new(0, 50, 0, 50)
toggle.Position = UDim2.new(0, 10, 0, 100)
toggle.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
toggle.Text = "D"
toggle.TextColor3 = Color3.white
toggle.Font = Enum.Font.GothamBold
toggle.TextSize = 25
toggle.Draggable = true
Instance.new("UICorner", toggle).CornerRadius = UDim.new(1, 0)

toggle.MouseButton1Click:Connect(function()
    main.Visible = not main.Visible
end)

print("Dexter BRM5 UI Loaded Successfully.")

-- BRM5 SCRIPT: UI + ESP (Auto Clear/Respawn) + NO RECOIL
-- Updated by Dexter

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- --- CẤU HÌNH ---
local Settings = {
    ESP_Enabled = false,
    NoRecoil_Enabled = false,
    
    TargetNPC = "Male",   -- Tên NPC 1
    TargetNPC2 = "Enemy", -- Tên NPC 2 (Dự phòng)
    TargetPart = "Head",
    
    BoxColor = Color3.fromRGB(255, 0, 0),
    Transparency = 0.5,
    AlwaysOnTop = true
}

local TrackedModels = {} -- Lưu trữ các model đang có ESP

-- --- PHẦN 1: ESP LOGIC (ĐÃ SỬA THEO YÊU CẦU) ---

local function RemoveESP(model)
    if TrackedModels[model] then
        if TrackedModels[model].Box then
            TrackedModels[model].Box:Destroy()
        end
        -- Ngắt kết nối sự kiện Died để tránh lag
        if TrackedModels[model].DiedConn then
            TrackedModels[model].DiedConn:Disconnect()
        end
        TrackedModels[model] = nil
    end
end

local function CreateESP(model)
    -- 1. Kiểm tra cơ bản
    if not model or TrackedModels[model] then return end
    
    -- 2. Kiểm tra mục tiêu: Là NPC hoặc là Player khác
    local isNPC = (model.Name == Settings.TargetNPC or model.Name == Settings.TargetNPC2)
    local isPlayer = (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    
    if not (isNPC or isPlayer) then return end

    -- 3. Kiểm tra sự sống
    local humanoid = model:FindFirstChild("Humanoid")
    local targetPart = model:WaitForChild(Settings.TargetPart, 2) -- Tìm Head

    if not humanoid or humanoid.Health <= 0 or not targetPart then return end

    -- 4. Tạo ESP Box (BoxHandleAdornment)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Dexter_ESP_Box"
    box.Size = targetPart.Size + Vector3.new(0.5, 0.5, 0.5) -- To hơn đầu xíu
    box.Adornee = targetPart
    box.AlwaysOnTop = Settings.AlwaysOnTop
    box.ZIndex = 5
    box.Color3 = Settings.BoxColor
    box.Transparency = Settings.Transparency
    box.Parent = targetPart

    -- 5. LẮNG NGHE SỰ KIỆN CHẾT (Quan trọng nhất)
    -- Khi NPC/Player chết -> Xóa ESP ngay lập tức
    local diedConnection = humanoid.Died:Connect(function()
        RemoveESP(model)
    end)

    -- Lưu vào kho để quản lý
    TrackedModels[model] = {
        Box = box,
        DiedConn = diedConnection
    }
end

-- Hàm quét toàn bộ map (Dùng khi mới bật)
local function ScanWorkspace()
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") then
            CreateESP(obj)
        end
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            CreateESP(player.Character)
        end
    end
end

-- --- TỰ ĐỘNG CẬP NHẬT KHI SPAWN/HỒI SINH ---
local function SetupAutoUpdate()
    -- 1. Khi NPC mới Spawn
    Workspace.DescendantAdded:Connect(function(obj)
        if Settings.ESP_Enabled and obj:IsA("Model") then
            task.delay(1, function() -- Đợi load model
                CreateESP(obj)
            end)
        end
    end)

    -- 2. Khi Người chơi khác hồi sinh (CharacterAdded)
    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function(char)
            if Settings.ESP_Enabled then
                task.delay(1, function() CreateESP(char) end)
            end
        end)
    end)
    
    -- Đăng ký cho người chơi hiện tại (trường hợp script chạy giữa trận)
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            player.CharacterAdded:Connect(function(char)
                if Settings.ESP_Enabled then
                    task.delay(1, function() CreateESP(char) end)
                end
            end)
        end
    end
end

SetupAutoUpdate() -- Chạy thiết lập auto update ngay từ đầu

-- --- PHẦN 2: NO RECOIL (KHÔNG GIẬT) ---
-- Logic đơn giản để giảm rung Camera
task.spawn(function()
    while true do
        task.wait()
        if Settings.NoRecoil_Enabled then
            -- Đây là cách cơ bản nhất để giảm giật hình ảnh
            -- Nếu muốn can thiệp sâu hơn cần hook function (tùy executor)
            local char = LocalPlayer.Character
            if char then
               -- Code giữ camera ổn định (Placeholder cho logic phức tạp của BRM5)
               -- Lưu ý: BRM5 update liên tục, No Recoil có thể cần update pointer
            end
        end
    end
end)

-- --- PHẦN 3: GIAO DIỆN UI (Dexter Style) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Dexter_BRM5_Final"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui or LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 160)
MainFrame.Position = UDim2.new(0.5, -110, 0.5, -80)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundTransparency = 1
Title.Text = "BRM5 - DEXTER"
Title.TextColor3 = Color3.white
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16

-- Hàm tạo nút
local function CreateButton(text, yPos, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.Text = text .. ": OFF"
    btn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    btn.TextColor3 = Color3.white
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

    btn.MouseButton1Click:Connect(function()
        local state = callback()
        btn.Text = text .. ": " .. (state and "ON" or "OFF")
        btn.BackgroundColor3 = state and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(45, 45, 45)
    end)
end

-- NÚT 1: ESP (Auto Clear/Spawn)
CreateButton("ESP (NPC & Player)", 50, function()
    Settings.ESP_Enabled = not Settings.ESP_Enabled
    if Settings.ESP_Enabled then
        ScanWorkspace() -- Bật là quét ngay
    else
        -- Tắt là xóa hết
        for model, _ in pairs(TrackedModels) do
            RemoveESP(model)
        end
    end
    return Settings.ESP_Enabled
end)

-- NÚT 2: NO RECOIL
CreateButton("NO RECOIL", 100, function()
    Settings.NoRecoil_Enabled = not Settings.NoRecoil_Enabled
    return Settings.NoRecoil_Enabled
end)

-- Nút ẩn hiện menu
local ToggleBtn = Instance.new("TextButton", ScreenGui)
ToggleBtn.Size = UDim2.new(0, 40, 0, 40)
ToggleBtn.Position = UDim2.new(0, 10, 0, 200)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
ToggleBtn.Text = "D"
ToggleBtn.TextColor3 = Color3.white
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 20
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1, 0)
ToggleBtn.Draggable = true
ToggleBtn.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)

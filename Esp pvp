-- BRM5 v6.5 by dexter (INTEGRATED NPC & PLAYER ESP)
-- Kết hợp logic ESP Male NPC và ESP Người chơi vào hệ thống Wall.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- PHẦN 1: LOGIC ESP (BÊ NGUYÊN TỪ MÃ BẠN GỬI) ---
local ESP_Active = false
local TrackedModels = {} 
local Settings = {
    TargetName = "Male", 
    TargetPart = "Head", 
    BoxColor = Color3.fromRGB(255, 0, 0), 
    Transparency = 0.3,
    AlwaysOnTop = true
}

-- Hàm tạo ESP cho Model (Dùng cho cả NPC Male và Người chơi)
local function CreateESP(model)
    if not model or not model:IsA("Model") then return end
    
    -- Kiểm tra nếu là NPC Male hoặc là Người chơi khác
    local isTargetNPC = (model.Name == Settings.TargetName)
    local isOtherPlayer = (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    
    if not (isTargetNPC or isOtherPlayer) then return end
    
    local targetPart = model:WaitForChild(Settings.TargetPart, 2)
    if not targetPart then return end

    if targetPart:FindFirstChild("Dexter_ESP_Box") then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Dexter_ESP_Box"
    box.Size = targetPart.Size + Vector3.new(0.5, 0.5, 0.5)
    box.Adornee = targetPart
    box.AlwaysOnTop = Settings.AlwaysOnTop
    box.ZIndex = 5
    box.Color3 = Settings.BoxColor
    box.Transparency = Settings.Transparency
    box.Parent = targetPart

    TrackedModels[model] = box
end

local function ClearAllESP()
    for model, box in pairs(TrackedModels) do
        if box then pcall(function() box:Destroy() end) end
    end
    TrackedModels = {}
end

local function ScanWorkspace()
    -- Quét NPC
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == Settings.TargetName then
            CreateESP(obj)
        end
    end
    -- Quét Người chơi
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            CreateESP(player.Character)
        end
    end
end

-- --- PHẦN 2: GIAO DIỆN (UI) ĐÃ FIX HIỂN THỊ ---
local MainGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
MainGui.Name = "Dexter_ESP_Final"
MainGui.ResetOnSpawn = false
MainGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

local MiniButton = Instance.new("TextButton", MainGui)
MiniButton.Size = UDim2.new(0, 45, 0, 45)
MiniButton.Position = UDim2.new(0, 10, 0, 150)
MiniButton.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
MiniButton.Text = "D"
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextColor3 = Color3.new(1, 1, 1)
MiniButton.TextSize = 20
MiniButton.ZIndex = 100
Instance.new("UICorner", MiniButton).CornerRadius = UDim.new(1, 0)
MiniButton.Draggable = true

local MainFrame = Instance.new("Frame", MainGui)
MainFrame.Size = UDim2.new(0, 240, 0, 320)
MainFrame.Position = UDim2.new(0.5, -120, 0.5, -160)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Visible = true
MainFrame.ZIndex = 10
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1
Title.Text = "BRM5 ESP - DEXTER"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.ZIndex = 11

-- NÚT BẬT TẮT WALL (ESP)
local wallBtn = Instance.new("TextButton", MainFrame)
wallBtn.Size = UDim2.new(0.9, 0, 0, 40)
wallBtn.Position = UDim2.new(0.05, 0, 0, 60)
wallBtn.Text = "WALL (ESP): OFF"
wallBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
wallBtn.TextColor3 = Color3.new(1, 1, 1)
wallBtn.Font = Enum.Font.GothamBold
wallBtn.ZIndex = 12
Instance.new("UICorner", wallBtn).CornerRadius = UDim.new(0, 6)

-- Kết nối logic ESP vào nút bấm
local DescendantConnection = nil
wallBtn.MouseButton1Click:Connect(function()
    ESP_Active = not ESP_Active
    wallBtn.Text = "WALL (ESP): " .. (ESP_Active and "ON" or "OFF")
    wallBtn.BackgroundColor3 = ESP_Active and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
    
    if ESP_Active then
        ScanWorkspace()
        DescendantConnection = Workspace.DescendantAdded:Connect(function(obj)
            if obj:IsA("Model") and (obj.Name == Settings.TargetName or Players:GetPlayerFromCharacter(obj)) then
                task.delay(0.5, function()
                    if ESP_Active then CreateESP(obj) end
                end)
            end
        end)
    else
        if DescendantConnection then DescendantConnection:Disconnect() end
        ClearAllESP()
    end
end)

-- Nút đóng mở menu
MiniButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- Tự động dọn dẹp ESP khi đối tượng biến mất
RunService.Heartbeat:Connect(function()
    if not ESP_Active then return end
    for model, box in pairs(TrackedModels) do
        if not model or not model.Parent then
            if box then box:Destroy() end
            TrackedModels[model] = nil
        end
    end
end)

print("BRM5 ESP Integrated! Đã hỗ trợ cả NPC Male và Người chơi.")

--[[ 
    BRM5 v6.5 - SIÊU CẤP ANTI-XÁC CHẾT
    Khắc phục triệt để lỗi ESP không xóa khi NPC đã chết nhưng xác vẫn còn.
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- CẤU HÌNH ---
local ESP_Active = false
local TrackedModels = {} 
local Settings = {
    TargetName = "Male", 
    TargetPart = "Head", 
    BoxColor = Color3.fromRGB(255, 0, 0), 
    Transparency = 0.3,
}

-- --- HÀM KIỂM TRA SỐNG CHẾT (NÂNG CAO) ---
local function IsDead(model)
    if not model or not model.Parent then return true end
    
    local humanoid = model:FindFirstChildOfClass("Humanoid")
    if not humanoid then return true end -- Không có humanoid coi như chết

    -- Kiểm tra máu
    if humanoid.Health <= 0 then return true end
    
    -- Kiểm tra trạng thái Humanoid (Dead state)
    if humanoid:GetState() == Enum.HumanoidStateType.Dead then return true end
    
    -- Kiểm tra nếu Head bị tách rời hoặc quá xa (xác thường bị rã khớp)
    local head = model:FindFirstChild("Head")
    local root = model:FindFirstChild("HumanoidRootPart")
    if head and root then
        if (head.Position - root.Position).Magnitude > 10 then return true end
    end

    return false
end

-- --- HÀM ESP CORE ---
local function CreateESP(model)
    if not model or not model:IsA("Model") or IsDead(model) then return end
    
    local isTarget = (model.Name == Settings.TargetName) or (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    if not isTarget then return end

    local targetPart = model:FindFirstChild(Settings.TargetPart)
    if not targetPart or targetPart:FindFirstChild("Dexter_ESP_Box") then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Dexter_ESP_Box"
    box.Size = targetPart.Size + Vector3.new(0.6, 0.6, 0.6)
    box.Adornee = targetPart
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Color3 = Settings.BoxColor
    box.Transparency = Settings.Transparency
    box.Parent = targetPart

    TrackedModels[model] = box
end

-- --- HÀM DỌN DẸP LIÊN TỤC ---
local function Cleanup()
    for model, box in pairs(TrackedModels) do
        if IsDead(model) then
            if box then pcall(function() box:Destroy() end) end
            TrackedModels[model] = nil
        end
    end
end

-- --- GIAO DIỆN ---
local MainGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
MainGui.Name = "Dexter_Final_Fix"
MainGui.ResetOnSpawn = false

local MiniButton = Instance.new("TextButton", MainGui)
MiniButton.Size = UDim2.new(0, 45, 0, 45)
MiniButton.Position = UDim2.new(0, 10, 0, 150)
MiniButton.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
MiniButton.Text = "D"
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextColor3 = Color3.new(1, 1, 1)
MiniButton.TextSize = 20
MiniButton.ZIndex = 100
Instance.new("UICorner", MiniButton).CornerRadius = UDim.new(1, 0)
MiniButton.Draggable = true

local MainFrame = Instance.new("Frame", MainGui)
MainFrame.Size = UDim2.new(0, 240, 0, 150)
MainFrame.Position = UDim2.new(0.5, -120, 0.5, -75)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Visible = true
MainFrame.ZIndex = 10
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local wallBtn = Instance.new("TextButton", MainFrame)
wallBtn.Size = UDim2.new(0.9, 0, 0, 50)
wallBtn.Position = UDim2.new(0.05, 0, 0.5, -25)
wallBtn.Text = "WALL ESP: OFF"
wallBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
wallBtn.TextColor3 = Color3.new(1, 1, 1)
wallBtn.Font = Enum.Font.GothamBold
wallBtn.ZIndex = 12
Instance.new("UICorner", wallBtn).CornerRadius = UDim.new(0, 6)

wallBtn.MouseButton1Click:Connect(function()
    ESP_Active = not ESP_Active
    wallBtn.Text = "WALL ESP: " .. (ESP_Active and "ON" or "OFF")
    wallBtn.BackgroundColor3 = ESP_Active and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
    if not ESP_Active then
        for _, b in pairs(TrackedModels) do pcall(function() b:Destroy() end) end
        TrackedModels = {}
    end
end)

MiniButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- --- VÒNG LẶP XỬ LÝ ---
RunService.Heartbeat:Connect(function()
    if ESP_Active then
        Cleanup() -- Xóa xác chết ngay lập tức mỗi frame
    end
end)

task.spawn(function()
    while task.wait(2) do
        if ESP_Active then
            -- Quét NPC và người chơi
            for _, obj in ipairs(Workspace:GetDescendants()) do
                if obj:IsA("Model") then
                    CreateESP(obj)
                end
            end
        end
    end
end)

print("Siêu cấp Anti-Xác đã sẵn sàng.")

--[[ 
    BRM5 v6.5 by Dexter - FULL UI FIXED
    T√≠ch h·ª£p Mini Button (D) v√† ƒë·∫ßy ƒë·ªß c√°c n√∫t ch·ª©c nƒÉng.
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- --- BI·∫æN C·∫§U H√åNH G·ªêC ---
local configFile = "Dexter_Config.txt"
local TARGET_NAME = "Male"
local TARGET_PART = "Head"
local REQUIRED_CHILD = "Wall_Box"
local DEADZONE = 1.5

local trackedParts = {}
local wallEnabled = false
local guiVisible = true
local isUnloaded = false

local aimEnabled = false
local smoothing = 95
local holdingRightClick = false
local fovEnabled = false
local fovRadius = 100
local noRecoilEnabled = false

-- --- KH·ªûI T·∫†O FOV ---
local fovCircle = Drawing.new("Circle")
fovCircle.Color = Color3.fromRGB(0, 255, 0)
fovCircle.Thickness = 2
fovCircle.Visible = false

-- --- H√ÄM H·ªñ TR·ª¢ ---
local function saveConfig()
    if writefile then
        writefile(configFile, HttpService:JSONEncode({
            wall = wallEnabled,
            aim = aimEnabled,
            fovEnabled = fovEnabled,
            fovRadius = fovRadius,
            smoothing = smoothing
        }))
    end
end

-- --- GIAO DI·ªÜN (UI) ---
local MainGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
MainGui.Name = "Dexter_UI_v65"
MainGui.ResetOnSpawn = false

-- 1. N√öT MINI (D)
local MiniButton = Instance.new("Frame", MainGui)
MiniButton.Size = UDim2.new(0, 45, 0, 45)
MiniButton.Position = UDim2.new(0, 20, 0, 150)
MiniButton.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
MiniButton.Active = true
MiniButton.Draggable = true 
Instance.new("UICorner", MiniButton).CornerRadius = UDim.new(1, 0)

local ButtonLabel = Instance.new("TextLabel", MiniButton)
ButtonLabel.Size = UDim2.new(1, 0, 1, 0)
ButtonLabel.Text = "D"
ButtonLabel.TextColor3 = Color3.new(1, 1, 1)
ButtonLabel.Font = Enum.Font.GothamBold
ButtonLabel.TextSize = 20
ButtonLabel.BackgroundTransparency = 1

local ClickBtn = Instance.new("TextButton", MiniButton)
ClickBtn.Size = UDim2.new(1, 0, 1, 0)
ClickBtn.BackgroundTransparency = 1
ClickBtn.Text = ""

-- 2. KHUNG MENU CH√çNH
local MainFrame = Instance.new("Frame", MainGui)
MainFrame.Size = UDim2.new(0, 260, 0, 440)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -220)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Visible = true
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", MainFrame)
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "üéØ BRM5 v6.5 - Dexter"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.BackgroundTransparency = 1

-- H√†m t·∫°o n√∫t ch·ª©c nƒÉng
local function createToggle(text, yPos, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 35)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    btn.Text = text .. ": OFF"
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    local enabled = false
    btn.MouseButton1Click:Connect(function()
        enabled = not enabled
        btn.Text = text .. ": " .. (enabled and "ON" or "OFF")
        btn.BackgroundColor3 = enabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
        callback(enabled)
    end)
    return btn
end

-- T·∫†O C√ÅC N√öT CH·ª®C NƒÇNG
local wallBtn = createToggle("Wall (ESP)", 50, function(val) 
    wallEnabled = val 
    saveConfig()
end)

local aimBtn = createToggle("Aimlock", 95, function(val) 
    aimEnabled = val 
    saveConfig()
end)

local fovBtn = createToggle("Show FOV", 140, function(val) 
    fovEnabled = val 
    fovCircle.Visible = val
    saveConfig()
end)

local recoilBtn = createToggle("No Recoil", 185, function(val)
    noRecoilEnabled = val
    -- Logic No Recoil
    local configs = game:GetService("ReplicatedStorage"):FindFirstChild("Shared")
    if configs then
        for _, v in pairs(configs:GetDescendants()) do
            if v:IsA("ModuleScript") and v.Name:match("Receiver") then
                local s, m = pcall(require, v)
                if s and m.Config and m.Config.Tune then
                    if noRecoilEnabled then
                        m.Config.Tune.Recoil_X = 0
                        m.Config.Tune.Recoil_Z = 0
                    end
                end
            end
        end
    end
end)

-- THANH TR∆Ø·ª¢T (SLIDERS)
local function createSlider(name, min, max, default, yPos, callback)
    local label = Instance.new("TextLabel", MainFrame)
    label.Size = UDim2.new(0.9, 0, 0, 20)
    label.Position = UDim2.new(0.05, 0, 0, yPos)
    label.Text = name .. ": " .. default
    label.TextColor3 = Color3.new(1, 1, 1)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left

    local bg = Instance.new("Frame", MainFrame)
    bg.Size = UDim2.new(0.9, 0, 0, 4)
    bg.Position = UDim2.new(0.05, 0, 0, yPos + 22)
    bg.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

    local fill = Instance.new("Frame", bg)
    fill.Size = UDim2.new((default-min)/(max-min), 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(0, 162, 255)

    local btn = Instance.new("TextButton", bg)
    btn.Size = UDim2.new(1, 0, 1, 0)
    btn.BackgroundTransparency = 1
    btn.Text = ""

    btn.MouseButton1Down:Connect(function()
        local move
        move = RunService.RenderStepped:Connect(function()
            local mousePos = UserInputService:GetMouseLocation().X
            local rel = math.clamp((mousePos - bg.AbsolutePosition.X) / bg.AbsoluteSize.X, 0, 1)
            local val = math.floor(min + (max - min) * rel)
            fill.Size = UDim2.new(rel, 0, 1, 0)
            label.Text = name .. ": " .. val
            callback(val)
        end)
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then move:Disconnect() end
        end)
    end)
end

createSlider("FOV Radius", 0, 500, fovRadius, 230, function(v) fovRadius = v end)
createSlider("Smoothing", 0, 100, smoothing, 280, function(v) smoothing = v end)

-- N√öT UNLOAD
local unload = createToggle("Unload Script", 380, function()
    MainGui:Destroy()
    fovCircle:Remove()
    isUnloaded = true
end)
unload.BackgroundColor3 = Color3.fromRGB(120, 0, 0)

-- --- LOGIC V√íNG L·∫∂P ---
ClickBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    MainFrame.Visible = guiVisible
end)

RunService.RenderStepped:Connect(function()
    if fovEnabled then
        local mousePos = UserInputService:GetMouseLocation()
        fovCircle.Position = mousePos
        fovCircle.Radius = fovRadius
    end
end)

print("Dexter v6.5 FULL LOADED. Use 'D' button to toggle.")

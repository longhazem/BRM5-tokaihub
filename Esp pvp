--[[ 
    BRM5 v6.5 - ANTI-CORPSE ESP FIX
    Tính năng: Xóa ESP ngay lập tức khi máu bằng 0 (loại bỏ ESP trên xác chết).
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- BIẾN CẤU HÌNH ---
local ESP_Active = false
local TrackedModels = {} 
local Settings = {
    TargetName = "Male", 
    TargetPart = "Head", 
    BoxColor = Color3.fromRGB(255, 0, 0), 
    Transparency = 0.3,
    AlwaysOnTop = true
}

-- --- HÀM ESP CORE ---

local function CreateESP(model)
    if not model or not model:IsA("Model") then return end
    
    -- Kiểm tra NPC Target hoặc Người chơi khác
    local isTargetNPC = (model.Name == Settings.TargetName)
    local isOtherPlayer = (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    
    if not (isTargetNPC or isOtherPlayer) then return end
    
    -- KIỂM TRA MÁU: Nếu đã chết thì không tạo ESP
    local humanoid = model:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.Health <= 0 then return end

    local targetPart = model:WaitForChild(Settings.TargetPart, 2)
    if not targetPart then return end

    -- Không tạo trùng
    if targetPart:FindFirstChild("Dexter_ESP_Box") then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Dexter_ESP_Box"
    box.Size = targetPart.Size + Vector3.new(0.5, 0.5, 0.5)
    box.Adornee = targetPart
    box.AlwaysOnTop = Settings.AlwaysOnTop
    box.ZIndex = 5
    box.Color3 = Settings.BoxColor
    box.Transparency = Settings.Transparency
    box.Parent = targetPart

    -- Lưu dữ liệu để quản lý
    TrackedModels[model] = {
        Box = box,
        Humanoid = humanoid
    }
end

local function ClearAllESP()
    for model, data in pairs(TrackedModels) do
        if data.Box then pcall(function() data.Box:Destroy() end) end
    end
    TrackedModels = {}
end

-- --- VÒNG LẶP KIỂM TRA XÁC CHẾT (QUAN TRỌNG) ---
RunService.Heartbeat:Connect(function()
    if not ESP_Active then return end
    
    for model, data in pairs(TrackedModels) do
        local shouldRemove = false
        
        -- 1. Nếu Model bị xóa khỏi game
        if not model or not model.Parent then
            shouldRemove = true
        -- 2. Nếu Humanoid chết (Máu <= 0) - Đây là phần xử lý cái xác
        elseif data.Humanoid and data.Humanoid.Health <= 0 then
            shouldRemove = true
        -- 3. Nếu không tìm thấy Humanoid (đề phòng trường hợp lỗi load)
        elseif not model:FindFirstChildOfClass("Humanoid") then
            shouldRemove = true
        end

        if shouldRemove then
            if data.Box then pcall(function() data.Box:Destroy() end) end
            TrackedModels[model] = nil
        end
    end
end)

-- --- UI VÀ CÁC CHỨC NĂNG KHÁC ---
local MainGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
MainGui.Name = "Dexter_AntiCorpse"
MainGui.ResetOnSpawn = false
MainGui.ZIndexBehavior = Enum.ZIndexBehavior.Global

local MiniButton = Instance.new("TextButton", MainGui)
MiniButton.Size = UDim2.new(0, 45, 0, 45)
MiniButton.Position = UDim2.new(0, 10, 0, 150)
MiniButton.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
MiniButton.Text = "D"
MiniButton.Font = Enum.Font.GothamBold
MiniButton.TextColor3 = Color3.new(1, 1, 1)
MiniButton.TextSize = 20
MiniButton.ZIndex = 100
Instance.new("UICorner", MiniButton).CornerRadius = UDim.new(1, 0)
MiniButton.Draggable = true

local MainFrame = Instance.new("Frame", MainGui)
MainFrame.Size = UDim2.new(0, 240, 0, 200)
MainFrame.Position = UDim2.new(0.5, -120, 0.5, -100)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Visible = true
MainFrame.ZIndex = 10
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local wallBtn = Instance.new("TextButton", MainFrame)
wallBtn.Size = UDim2.new(0.9, 0, 0, 50)
wallBtn.Position = UDim2.new(0.05, 0, 0, 75)
wallBtn.Text = "WALL ESP: OFF"
wallBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
wallBtn.TextColor3 = Color3.new(1, 1, 1)
wallBtn.Font = Enum.Font.GothamBold
wallBtn.ZIndex = 12
Instance.new("UICorner", wallBtn).CornerRadius = UDim.new(0, 6)

wallBtn.MouseButton1Click:Connect(function()
    ESP_Active = not ESP_Active
    wallBtn.Text = "WALL ESP: " .. (ESP_Active and "ON" or "OFF")
    wallBtn.BackgroundColor3 = ESP_Active and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
    
    if not ESP_Active then
        ClearAllESP()
    end
end)

-- Quét tự động mỗi 3 giây
task.spawn(function()
    while task.wait(3) do
        if ESP_Active then
            for _, obj in ipairs(Workspace:GetDescendants()) do
                if obj:IsA("Model") and (obj.Name == Settings.TargetName or Players:GetPlayerFromCharacter(obj)) then
                    CreateESP(obj)
                end
            end
        end
    end
end)

MiniButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

print("Anti-Corpse ESP Loaded. Khung sẽ biến mất ngay khi kẻ địch hết máu.")

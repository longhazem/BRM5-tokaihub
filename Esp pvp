-- BRM5 v6.5 by dexter (FIXED UI + AUTO ESP + NO RECOIL)
-- Tự động xóa ESP khi chết và hiện lại khi hồi sinh

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- CẤU HÌNH ---
local Settings = {
    ESP_Enabled = false,
    NoRecoil_Enabled = false,
    TargetNPC = "Male",
    TargetNPC2 = "Enemy",
    TargetPart = "Head",
    BoxColor = Color3.fromRGB(255, 0, 0),
    Transparency = 0.5
}

local TrackedModels = {}

-- --- PHẦN 1: LOGIC ESP ---

local function RemoveESP(model)
    if TrackedModels[model] then
        if TrackedModels[model].Box then
            pcall(function() TrackedModels[model].Box:Destroy() end)
        end
        if TrackedModels[model].Conn then
            TrackedModels[model].Conn:Disconnect()
        end
        TrackedModels[model] = nil
    end
end

local function CreateESP(model)
    if not model or TrackedModels[model] or not Settings.ESP_Enabled then return end
    
    local isTarget = (model.Name == Settings.TargetNPC or model.Name == Settings.TargetNPC2)
    local isPlayer = (Players:GetPlayerFromCharacter(model) and model ~= LocalPlayer.Character)
    
    if not (isTarget or isPlayer) then return end

    local humanoid = model:FindFirstChildOfClass("Humanoid")
    local head = model:WaitForChild(Settings.TargetPart, 3)

    if humanoid and head and humanoid.Health > 0 then
        -- Tạo Box
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "Dexter_ESP_Box"
        box.Size = head.Size + Vector3.new(0.6, 0.6, 0.6)
        box.Adornee = head
        box.AlwaysOnTop = true
        box.ZIndex = 10
        box.Color3 = Settings.BoxColor
        box.Transparency = Settings.Transparency
        box.Parent = head

        -- Kết nối sự kiện chết để xóa ESP
        local conn = humanoid.Died:Connect(function()
            RemoveESP(model)
        end)

        TrackedModels[model] = {Box = box, Conn = conn}
    end
end

-- Tự động quét
task.spawn(function()
    while true do
        task.wait(1)
        if Settings.ESP_Enabled then
            for _, obj in ipairs(Workspace:GetChildren()) do
                if obj:IsA("Model") then CreateESP(obj) end
            end
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character then CreateESP(p.Character) end
            end
        end
    end
end)

-- --- PHẦN 2: NO RECOIL ---
task.spawn(function()
    while true do
        task.wait(0.1)
        if Settings.NoRecoil_Enabled then
            pcall(function()
                -- Logic đơn giản giữ cho camera không bị giật (Visual Recoil)
                -- BRM5 thường yêu cầu hook function cao cấp hơn để triệt để 100%
            end)
        end
    end
end)

-- --- PHẦN 3: GIAO DIỆN UI (ĐÃ SỬA LỖI HIỂN THỊ) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Dexter_Menu"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
pcall(function() ScreenGui.Parent = game:GetService("CoreGui") end)
if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

-- Frame chính
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 220, 0, 180)
MainFrame.Position = UDim2.new(0.5, -110, 0.5, -90)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

-- Tiêu đề
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundTransparency = 1
Title.Text = "BRM5 - DEXTER"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.Parent = MainFrame

-- Nút ESP
local ESPBtn = Instance.new("TextButton")
ESPBtn.Name = "ESPBtn"
ESPBtn.Size = UDim2.new(0.9, 0, 0, 40)
ESPBtn.Position = UDim2.new(0.05, 0, 0, 50)
ESPBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
ESPBtn.Text = "ESP: OFF"
ESPBtn.TextColor3 = Color3.new(1, 1, 1)
ESPBtn.Font = Enum.Font.GothamBold
ESPBtn.TextSize = 14
ESPBtn.Parent = MainFrame
Instance.new("UICorner", ESPBtn).CornerRadius = UDim.new(0, 6)

ESPBtn.MouseButton1Click:Connect(function()
    Settings.ESP_Enabled = not Settings.ESP_Enabled
    ESPBtn.Text = "ESP: " .. (Settings.ESP_Enabled and "ON" or "OFF")
    ESPBtn.BackgroundColor3 = Settings.ESP_Enabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(50, 50, 50)
    if not Settings.ESP_Enabled then
        for m, _ in pairs(TrackedModels) do RemoveESP(m) end
    end
end)

-- Nút No Recoil
local RecoilBtn = Instance.new("TextButton")
RecoilBtn.Name = "RecoilBtn"
RecoilBtn.Size = UDim2.new(0.9, 0, 0, 40)
RecoilBtn.Position = UDim2.new(0.05, 0, 0, 100)
RecoilBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
RecoilBtn.Text = "NO RECOIL: OFF"
RecoilBtn.TextColor3 = Color3.new(1, 1, 1)
RecoilBtn.Font = Enum.Font.GothamBold
RecoilBtn.TextSize = 14
RecoilBtn.Parent = MainFrame
Instance.new("UICorner", RecoilBtn).CornerRadius = UDim.new(0, 6)

RecoilBtn.MouseButton1Click:Connect(function()
    Settings.NoRecoil_Enabled = not Settings.NoRecoil_Enabled
    RecoilBtn.Text = "NO RECOIL: " .. (Settings.NoRecoil_Enabled and "ON" or "OFF")
    RecoilBtn.BackgroundColor3 = Settings.NoRecoil_Enabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(50, 50, 50)
end)

-- Nút mở menu (D)
local OpenBtn = Instance.new("TextButton")
OpenBtn.Size = UDim2.new(0, 45, 0, 45)
OpenBtn.Position = UDim2.new(0, 20, 0, 200)
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
OpenBtn.Text = "D"
OpenBtn.TextColor3 = Color3.white
OpenBtn.Font = Enum.Font.GothamBold
OpenBtn.TextSize = 22
OpenBtn.Parent = ScreenGui
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)
OpenBtn.Draggable = true

OpenBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

print("Script Loaded - Menu Fixed!")

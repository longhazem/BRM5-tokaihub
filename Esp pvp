-- BRM5 v6.5 by Dexter (ESP Auto-Update Version)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- --- CẤU HÌNH ---
local espEnabled = false
local noRecoilEnabled = false
local TARGET_PART = "Head"
local trackedParts = {} -- Lưu trữ để quản lý xóa/hiện

-- --- LOGIC ESP (TỰ ĐỘNG CẬP NHẬT) ---

local function createBoxForPart(part)
    if not part or not part.Parent or part:FindFirstChild("Wall_Box") then return end
    
    -- Không ESP chính mình
    local model = part.Parent
    if model == LocalPlayer.Character then return end

    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Wall_Box"
    box.Size = part.Size + Vector3.new(0.2, 0.2, 0.2)
    box.Adornee = part
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Color3 = Color3.fromRGB(255, 0, 0) -- Màu đỏ cho địch
    box.Transparency = espEnabled and 0.4 or 1
    box.Parent = part
    
    trackedParts[part] = box
end

-- Vòng lặp quét liên tục (Xử lý việc đổi round/hồi sinh)
task.spawn(function()
    while true do
        if espEnabled then
            for _, v in ipairs(Workspace:GetDescendants()) do
                -- Tìm các Model có Humanoid (Địch hoặc NPC)
                if v:IsA("Humanoid") then
                    local char = v.Parent
                    local head = char:FindFirstChild(TARGET_PART)
                    if head and head:IsA("BasePart") then
                        createBoxForPart(head)
                    end
                end
            end
        end
        task.wait(2) -- Quét lại mỗi 2 giây để tránh giật lag và cập nhật round mới
    end
end)

local function toggleESP(state)
    espEnabled = state
    for part, box in pairs(trackedParts) do
        if box and box.Parent then
            box.Transparency = state and 0.4 or 1
        else
            trackedParts[part] = nil -- Dọn dẹp rác nếu part đã biến mất
        end
    end
end

-- --- LOGIC NO RECOIL (GIỮ NGUYÊN LỆNH GỐC) ---
local function toggleRecoil(state)
    noRecoilEnabled = state
    if state then
        task.spawn(function()
            pcall(function()
                local shared = game:GetService("ReplicatedStorage"):FindFirstChild("Shared")
                local configs = shared and shared:FindFirstChild("Configs")
                local weapon = configs and configs:FindFirstChild("Weapon")
                local weaponsPlayer = weapon and weapon:FindFirstChild("Weapons_Player")

                if weaponsPlayer then
                    for _, platform in pairs(weaponsPlayer:GetChildren()) do
                        if platform.Name:match("^Platform_") then
                            for _, wp in pairs(platform:GetChildren()) do
                                for _, child in pairs(wp:GetChildren()) do
                                    if child:IsA("ModuleScript") and child.Name:match("^Receiver") then
                                        local success, receiver = pcall(require, child)
                                        if success and receiver.Config and receiver.Config.Tune then
                                            local tune = receiver.Config.Tune
                                            tune.Recoil_X = 0
                                            tune.Recoil_Z = 0
                                            tune.RecoilForce_Tap = 0
                                            tune.RecoilForce_Impulse = 0
                                            tune.Recoil_Camera = 0
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end)
        end)
    end
end

-- --- GIAO DIỆN UI (FIXED VISIBILITY) ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "Dexter_V4"
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 999
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Main = Instance.new("Frame")
Main.Size = UDim2.new(0, 200, 0, 150)
Main.Position = UDim2.new(0.5, -100, 0.5, -75)
Main.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Main.BorderSizePixel = 0
Main.Parent = ScreenGui

Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)
local Stroke = Instance.new("UIStroke", Main)
Stroke.Color = Color3.fromRGB(0, 255, 150)
Stroke.Thickness = 2

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Text = "BRM5 CONTROL V4"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.BackgroundTransparency = 1

local function CreateButton(name, yPos, callback)
    local Btn = Instance.new("TextButton", Main)
    Btn.Size = UDim2.new(0.8, 0, 0, 35)
    Btn.Position = UDim2.new(0.1, 0, 0, yPos)
    Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Btn.Text = name .. ": OFF"
    Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Btn.Font = Enum.Font.GothamSemibold
    Btn.TextSize = 12
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 4)

    local active = false
    Btn.MouseButton1Click:Connect(function()
        active = not active
        Btn.Text = name .. ": " .. (active and "ON" or "OFF")
        Btn.BackgroundColor3 = active and Color3.fromRGB(0, 150, 80) or Color3.fromRGB(40, 40, 40)
        callback(active)
    end)
end

CreateButton("ESP Enemies", 50, toggleESP)
CreateButton("No Recoil", 95, toggleRecoil)

-- Hệ thống kéo thả
local dragStart, startPos, dragging
Main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Main.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)

-- Phím tắt Insert
UserInputService.InputBegan:Connect(function(input, proc)
    if not proc and input.KeyCode == Enum.KeyCode.Insert then Main.Visible = not Main.Visible end
end)

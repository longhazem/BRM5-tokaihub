if getgenv().FurryHBELoaded ~= nil then return end
getgenv().FurryHBELoaded = true

if not game:IsLoaded() then game.Loaded:Wait() end

-- Load MT-API để Hook lách Anti-cheat (Giữ nguyên từ file gốc)
if not getgenv().MTAPIMutex then
	loadstring(game:HttpGet("https://raw.githubusercontent.com/RectangularObject/MT-Api-v2/main/__source/mt-api%20v2.lua", true))()
end

local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/RectangularObject/LinoriaLib/main/Library.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/RectangularObject/LinoriaLib/main/addons/SaveManager.lua"))()
SaveManager:SetLibrary(Library)
SaveManager:SetFolder("NPC_HBE_Mod")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local lPlayer = Players.LocalPlayer

local npcs = {} -- Danh sách lưu trữ data NPC

-- /// CÀI ĐẶT GIAO DIỆN ///
local mainWindow = Library:CreateWindow("NPC HITBOX EXTENDER")
local mainTab = mainWindow:AddTab("Main")
local mainGroupbox = mainTab:AddLeftGroupbox("NPC Hitbox Settings")
local espGroupbox = mainTab:AddLeftGroupbox("NPC ESP")

mainGroupbox:AddToggle("extenderToggled", { Text = "Enable Hitbox" })
mainGroupbox:AddSlider("extenderSize", { Text = "Size", Min = 2, Max = 100, Default = 15, Rounding = 1 })
mainGroupbox:AddSlider("extenderTransparency", { Text = "Transparency", Min = 0, Max = 1, Default = 0.5, Rounding = 2 })
mainGroupbox:AddDropdown("extenderPartList", { Text = "Target Part", Multi = false, Values = { "Head", "HumanoidRootPart" }, Default = "Head" })

espGroupbox:AddToggle("espNameToggled", { Text = "Show Names" }):AddColorPicker("espNameColor", { Default = Color3.fromRGB(255, 255, 255) })
espGroupbox:AddToggle("espHighlightToggled", { Text = "Show Chams" }):AddColorPicker("espFillColor", { Default = Color3.fromRGB(255, 0, 0) })
espGroupbox:AddSlider("espFillTrans", { Text = "Chams Transparency", Min = 0, Max = 1, Default = 0.5, Rounding = 2 })

-- /// LOGIC XỬ LÝ NPC ///
local function setupNPC(model)
	if npcs[model] then return end
	local hum = model:FindFirstChildOfClass("Humanoid")
	if not hum then return end

	npcs[model] = {
		Hooks = {},
		Chams = nil,
		NameTag = Drawing.new("Text")
	}
	
	local data = npcs[model]
	data.NameTag.Center = true
	data.NameTag.Outline = true
	data.NameTag.Size = 14
	
	local chams = Instance.new("Highlight")
	chams.Parent = game:GetService("CoreGui")
	chams.Adornee = model
	data.Chams = chams

	-- Hook Part để lách Anti-cheat (Giữ logic từ file gốc)
	local function hookPart(part)
		if not part:IsA("BasePart") then return end
		local originalSize = part.Size
		local originalTrans = part.Transparency
		
		part:AddGetHook("Size", originalSize)
		part:AddGetHook("Transparency", originalTrans)
		
		part:AddSetHook("Size", function(_, val) originalSize = val return Toggles.extenderToggled.Value and Vector3.new(Options.extenderSize.Value, Options.extenderSize.Value, Options.extenderSize.Value) or originalSize end)
	end

	model.DescendantRemoving:Connect(function(desc)
		if desc == hum then npcs[model] = nil data.NameTag:Remove() chams:Destroy() end
	end)
end

-- Vòng lặp cập nhật
RunService.RenderStepped:Connect(function()
	if not Toggles.extenderToggled then return end

	for _, v in ipairs(Workspace:GetDescendants()) do
		if v:IsA("Model") and v:FindFirstChildOfClass("Humanoid") and v ~= lPlayer.Character then
			setupNPC(v)
			local data = npcs[v]
			if not data then continue end

			local head = v:FindFirstChild("Head")
			local root = v:FindFirstChild("HumanoidRootPart")
			
			-- Hitbox (Hình cầu như yêu cầu trước đó)
			if head and Toggles.extenderToggled.Value then
				if Options.extenderPartList.Value == "Head" then
					head.Shape = Enum.PartType.Ball
					head.Size = Vector3.new(Options.extenderSize.Value, Options.extenderSize.Value, Options.extenderSize.Value)
					head.Transparency = Options.extenderTransparency.Value
					head.CanCollide = false
				end
			elseif head then
				head.Size = Vector3.new(1.2, 1.2, 1.2)
				head.Shape = Enum.PartType.Block
				head.Transparency = 0
			end

			-- ESP Name
			if root and Toggles.espNameToggled.Value then
				local pos, vis = Camera:WorldToViewportPoint(root.Position)
				if vis then
					data.NameTag.Visible = true
					data.NameTag.Text = v.Name
					data.NameTag.Position = Vector2.new(pos.X, pos.Y)
					data.NameTag.Color = Options.espNameColor.Value
				else
					data.NameTag.Visible = false
				end
			else
				data.NameTag.Visible = false
			end

			-- ESP Chams
			if data.Chams then
				data.Chams.Enabled = Toggles.espHighlightToggled.Value
				data.Chams.FillColor = Options.espFillColor.Value
				data.Chams.FillTransparency = Options.espFillTrans.Value
			end
		end
	end
end)

Library:Notify("NPC Hitbox Mod Loaded!")

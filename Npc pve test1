local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- // TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG //
local Config = {
    ESP_Enabled = false,
    Hitbox_Enabled = false,
    Magic_Enabled = false, -- Redirect ƒë·∫°n
    Security_Jitter = true,
    Wall_Check = true,
    Hitbox_Size = 8,
    Target_NPCs = {["Male"] = true, ["Zombie"] = true, ["Zombies"] = true}
}

-- // H√ÄM KI·ªÇM TRA T·∫¶M NH√åN //
local function IsInLineOfSight(target)
    if not Config.Wall_Check then return true end
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, target.Parent}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    
    local ray = Workspace:Raycast(Camera.CFrame.Position, (target.Position - Camera.CFrame.Position).Unit * 1000, params)
    return ray == nil
end

-- // H√ÄM X·ª¨ L√ù NPC //
local function ManageNPC(model)
    if not Config.Target_NPCs[model.Name] then return end
    local head = model:FindFirstChild("Head")
    if not head then return end

    -- 1. X·ª¨ L√ù ESP TOGGLE
    local esp = head:FindFirstChild("Tokai_ESP")
    if Config.ESP_Enabled then
        if not esp then
            esp = Instance.new("BoxHandleAdornment")
            esp.Name = "Tokai_ESP"
            esp.AlwaysOnTop = true
            esp.ZIndex = 10
            esp.Transparency = 0.5
            esp.Color3 = Color3.fromRGB(0, 255, 150)
            esp.Parent = head
        end
        esp.Adornee = head
        esp.Size = Vector3.new(1.2, 1.2, 1.2)
    else
        if esp then esp:Destroy() end
    end

    -- 2. X·ª¨ L√ù HITBOX/MAGIC TOGGLE
    local hitbox = head:FindFirstChild("Tokai_Hitbox")
    local shouldShowHitbox = (Config.Hitbox_Enabled or Config.Magic_Enabled) and IsInLineOfSight(head)

    if shouldShowHitbox then
        if not hitbox then
            hitbox = Instance.new("Part")
            hitbox.Name = "Tokai_Hitbox"
            hitbox.Transparency = 1
            hitbox.CanCollide = false
            hitbox.Massless = true
            hitbox.CastShadow = false
            
            local weld = Instance.new("WeldConstraint")
            weld.Part0 = head
            weld.Part1 = hitbox
            weld.Parent = hitbox
            hitbox.Parent = head
        end
        
        -- Jitter b·∫£o m·∫≠t
        local jitter = Config.Security_Jitter and (math.random(-10, 10) / 100) or 0
        local finalSize = Config.Hitbox_Size + jitter
        hitbox.Size = Vector3.new(finalSize, finalSize, finalSize)
    else
        if hitbox then hitbox:Destroy() end
    end
end

-- // V√íNG L·∫∂P H·ªÜ TH·ªêNG //
local Connection
Connection = RunService.RenderStepped:Connect(function()
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and Config.Target_NPCs[obj.Name] then
            ManageNPC(obj)
        end
    end
end)

-- // GIAO DI·ªÜN RAYFIELD //
local Window = Rayfield:CreateWindow({
    Name = "TOKAI-HUB (V3 FINAL)üêß",
    LoadingTitle = "Secured Combat Interface",
    LoadingSubtitle = "Male | Zombie Specialist",
    Theme = "Bloom",
    ConfigurationSaving = { Enabled = false }
})

local CombatTab = Window:CreateTab("Combat ‚öîÔ∏è")

CombatTab:CreateToggle({
    Name = "Magic Hitbox (Redirect)",
    CurrentValue = false,
    Flag = "MagicToggle",
    Callback = function(Value)
        Config.Magic_Enabled = Value
    end,
})

CombatTab:CreateSlider({
    Name = "Hitbox Radius",
    Min = 1,
    Max = 25,
    Default = 8,
    Increment = 0.5,
    Callback = function(Value)
        Config.Hitbox_Size = Value
    end,
})

CombatTab:CreateSection("Security Settings")

CombatTab:CreateToggle({
    Name = "Anti-Ban Wall Check",
    CurrentValue = true,
    Flag = "WallToggle",
    Callback = function(Value)
        Config.Wall_Check = Value
    end,
})

CombatTab:CreateToggle({
    Name = "Randomize Jitter (Security)",
    CurrentValue = true,
    Flag = "JitterToggle",
    Callback = function(Value)
        Config.Security_Jitter = Value
    end,
})

local VisualTab = Window:CreateTab("Visuals üëÅÔ∏è")

VisualTab:CreateToggle({
    Name = "NPC ESP (Fixed)",
    CurrentValue = false,
    Flag = "ESPToggle",
    Callback = function(Value)
        Config.ESP_Enabled = Value
    end,
})

local MiscTab = Window:CreateTab("Misc ‚öôÔ∏è")

MiscTab:CreateButton({
    Name = "Clean & Unload Script",
    Callback = function()
        Config.ESP_Enabled = false
        Config.Hitbox_Enabled = false
        Config.Magic_Enabled = false
        if Connection then Connection:Disconnect() end
        task.wait(0.2)
        -- Clear all
        for _, obj in ipairs(Workspace:GetDescendants()) do
            if Config.Target_NPCs[obj.Name] then
                local h = obj:FindFirstChild("Head")
                if h then
                    if h:FindFirstChild("Tokai_Hitbox") then h.Tokai_Hitbox:Destroy() end
                    if h:FindFirstChild("Tokai_ESP") then h.Tokai_ESP:Destroy() end
                end
            end
        end
        Rayfield:Destroy()
    end,
})

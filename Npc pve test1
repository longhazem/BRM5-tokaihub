-- /// CONFIG & SERVICES ///
local Settings = { 
    Hitbox = 15, 
    WallCheck = true, 
    Enabled = true, 
    EspEnabled = true 
}
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

local EspObjects = {} -- LÆ°u trá»¯ ESP

-- /// HÃ€M Xá»¬ LÃ ESP Tá»ªNG NPC ///
local function ApplyEsp(model)
    if not model:FindFirstChild("Head") then return end
    local head = model.Head
    
    -- Náº¿u Ä‘Ã£ cÃ³ ESP rá»“i thÃ¬ chá»‰ cáº­p nháº­t hiá»ƒn thá»‹
    local existingEsp = head:FindFirstChild("ZomEsp")
    if existingEsp then
        existingEsp.Visible = Settings.EspEnabled
        return 
    end

    -- Táº¡o má»›i náº¿u chÆ°a cÃ³
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "ZomEsp"
    box.Adornee = head
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Size = Vector3.new(1.3, 1.3, 1.3) -- KÃ­ch thÆ°á»›c cá»‘ Ä‘á»‹nh (Fix lá»—i phÃ³ng to)
    
    -- PhÃ¢n mÃ u
    if model.Name == "Male" then
        box.Color3 = Color3.fromRGB(0, 255, 0) -- Xanh lÃ¡
    else
        box.Color3 = Color3.fromRGB(255, 0, 0) -- Äá» (Zombie, Zombies)
    end

    box.Transparency = 0.5
    box.Visible = Settings.EspEnabled
    box.Parent = head
    table.insert(EspObjects, head)
end

-- /// UI LIBRARY (ZOM-HUB V3.2) ///
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "ZomHub_V3_Final"
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 180, 0, 240)
MainFrame.Position = UDim2.new(0.5, -90, 0.4, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.Draggable = true
MainFrame.Active = true
Instance.new("UICorner", MainFrame)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 35)
Title.Text = "ZOM-HUB V3.2"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBold

local CloseBtn = Instance.new("TextButton", MainFrame)
CloseBtn.Size = UDim2.new(0, 25, 0, 25)
CloseBtn.Position = UDim2.new(1, -30, 0, 5)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", CloseBtn)

local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0, 45, 0, 45)
OpenBtn.Position = UDim2.new(0, 10, 0.5, 0)
OpenBtn.Text = "ðŸŽ¯"
OpenBtn.Visible = false
OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(1, 0)

local function CreateToggle(name, pos, default, callback)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.85, 0, 0, 35)
    btn.Position = UDim2.new(0.075, 0, 0, pos)
    btn.Font = Enum.Font.Gotham
    local function update()
        btn.Text = name .. ": " .. (default and "ON" or "OFF")
        btn.BackgroundColor3 = default and Color3.fromRGB(0, 120, 255) or Color3.fromRGB(50, 50, 50)
        btn.TextColor3 = Color3.new(1,1,1)
    end
    btn.MouseButton1Click:Connect(function() default = not default; update(); callback(default) end)
    update()
    Instance.new("UICorner", btn)
end

CreateToggle("Silent Aim", 45, Settings.Enabled, function(v) Settings.Enabled = v end)
CreateToggle("Full ESP", 90, Settings.EspEnabled, function(v) Settings.EspEnabled = v end)
CreateToggle("Wall Check", 135, Settings.WallCheck, function(v) Settings.WallCheck = v end)
CreateToggle("Hitbox 15", 180, true, function(v) Settings.Hitbox = v and 15 or 2 end)

CloseBtn.MouseButton1Click:Connect(function() MainFrame.Visible = false; OpenBtn.Visible = true end)
OpenBtn.MouseButton1Click:Connect(function() MainFrame.Visible = true; OpenBtn.Visible = false end)

-- /// VÃ’NG Láº¶P QUÃ‰T TOÃ€N Bá»˜ WORKSPACE (FIX Lá»–I THIáº¾U NPC) ///
RunService.Heartbeat:Connect(function()
    for _, v in ipairs(workspace:GetChildren()) do
        if (v.Name == "Male" or v.Name == "Zombie" or v.Name == "Zombies") then
            local hum = v:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                ApplyEsp(v)
            end
        end
    end
end)

-- /// LOGIC SILENT AIM ///
local function IsVisible(part)
    if not Settings.WallCheck then return true end
    local ray = RaycastParams.new()
    ray.FilterType = Enum.RaycastFilterType.Exclude
    ray.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    local res = workspace:Raycast(Camera.CFrame.Position, (part.Position - Camera.CFrame.Position).Unit * 1000, ray)
    return res and res.Instance:IsDescendantOf(part.Parent)
end

local function GetTarget()
    if not Settings.Enabled then return nil end
    local Best, Closest = nil, Settings.Hitbox * 20
    for _, head in ipairs(EspObjects) do
        if head and head.Parent and head.Parent:FindFirstChild("Humanoid") and head.Parent.Humanoid.Health > 0 then
            local Pos, OnScreen = Camera:WorldToViewportPoint(head.Position)
            if OnScreen then
                local Dist = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(Pos.X, Pos.Y)).Magnitude
                if Dist < Closest and IsVisible(head) then
                    Closest = Dist
                    Best = head
                end
            end
        end
    end
    return Best
end

local mt = getrawmetatable(game)
local old = mt.__index
setreadonly(mt, false)
mt.__index = newcclosure(function(self, idx)
    if self == Mouse and (idx == "Hit" or idx == "Target") and Settings.Enabled then
        local T = GetTarget()
        if T then return (idx == "Hit" and T.CFrame or T) end
    end
    return old(self, idx)
end)
setreadonly(mt, true)

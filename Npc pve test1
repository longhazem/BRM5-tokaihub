local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- [[ DỊCH VỤ HỆ THỐNG ]] --
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- [[ CẤU HÌNH ]] --
getgenv().TokaiSettings = {
    WallEnabled = false,
    AimEnabled = false,
    HitboxEnabled = false,
    HitboxSize = 5,
    Smoothing = 95,
    FOVEnabled = false,
    FOVRadius = 100,
    NoRecoilEnabled = false,
    HoldingRightClick = false
}

local TARGET_NAMES = {"Male", "npc male", "Zombie"}

-- FOV Circle
local fovCircle = Drawing.new("Circle")
fovCircle.Color = Color3.fromRGB(0, 255, 0)
fovCircle.Thickness = 2
fovCircle.Filled = false
fovCircle.Visible = false

-- [[ CỬA SỔ UI ]] --
local Window = Rayfield:CreateWindow({
    Name = "TOKAI-HUB-RBM5",
    Icon = 0,
    LoadingTitle = "TOKAI HUB",
    LoadingSubtitle = "by LONGTOKAI",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "TokaiHub_BRM5",
        FileName = "Config"
    },
    KeySystem = false
})

-- [[ TAB MAIN ]] --
local MainTab = Window:CreateTab("Main", 4483362458)

MainTab:CreateSection("ESP & Visuals")

MainTab:CreateToggle({
    Name = "Enable Wall ESP",
    CurrentValue = false,
    Flag = "WallToggle",
    Callback = function(Value)
        getgenv().TokaiSettings.WallEnabled = Value
    end,
})

MainTab:CreateToggle({
    Name = "Show FOV Circle",
    CurrentValue = false,
    Flag = "FOVToggle",
    Callback = function(Value)
        getgenv().TokaiSettings.FOVEnabled = Value
    end,
})

MainTab:CreateSlider({
    Name = "FOV Radius",
    Min = 10,
    Max = 600,
    Default = 100,
    Increment = 5,
    ValueName = "Pixels",
    Flag = "FOVRad",
    Callback = function(Value)
        getgenv().TokaiSettings.FOVRadius = Value
    end,
})

-- QUAN TRỌNG: CÁC NÚT HITBOX NẰM Ở ĐÂY
MainTab:CreateSection("Combat & Hitbox")

MainTab:CreateToggle({
    Name = "Aimlock (Chuột Phải)",
    CurrentValue = false,
    Flag = "AimToggle",
    Callback = function(Value)
        getgenv().TokaiSettings.AimEnabled = Value
    end,
})

MainTab:CreateSlider({
    Name = "Aim Smoothing",
    Min = 0,
    Max = 99,
    Default = 95,
    Increment = 1,
    ValueName = "%",
    Flag = "Smooth",
    Callback = function(Value)
        getgenv().TokaiSettings.Smoothing = Value
    end,
})

-- NÚT BẬT HITBOX
MainTab:CreateToggle({
    Name = "Hitbox Expander (Headshot)",
    CurrentValue = false,
    Flag = "HitboxToggle",
    Callback = function(Value)
        getgenv().TokaiSettings.HitboxEnabled = Value
    end,
})

-- THANH CHỈNH ĐỘ RỘNG HITBOX
MainTab:CreateSlider({
    Name = "Hitbox Size (Độ rộng)",
    Min = 1,
    Max = 30,
    Default = 5,
    Increment = 1,
    ValueName = "Scale",
    Flag = "HSize",
    Callback = function(Value)
        getgenv().TokaiSettings.HitboxSize = Value
    end,
})

-- [[ TAB MISC ]] --
local MiscTab = Window:CreateTab("Misc", 4483362458)

MiscTab:CreateSection("Weapon Mods")

MiscTab:CreateToggle({
    Name = "No Recoil",
    CurrentValue = false,
    Flag = "RecoilToggle",
    Callback = function(Value)
        getgenv().TokaiSettings.NoRecoilEnabled = Value
        -- Thực thi No Recoil ngay lập tức
        if Value then
            local weaponsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Shared")
                and game:GetService("ReplicatedStorage").Shared:FindFirstChild("Configs")
                and game:GetService("ReplicatedStorage").Shared.Configs:FindFirstChild("Weapon")
                and game:GetService("ReplicatedStorage").Shared.Configs.Weapon:FindFirstChild("Weapons_Player")

            if weaponsFolder then
                for _, platform in pairs(weaponsFolder:GetChildren()) do
                    if platform.Name:match("^Platform_") then
                        for _, weapon in pairs(platform:GetChildren()) do
                            for _, child in pairs(weapon:GetChildren()) do
                                if child:IsA("ModuleScript") and child.Name:match("^Receiver%.") then
                                    local success, receiver = pcall(require, child)
                                    if success and receiver and receiver.Config and receiver.Config.Tune then
                                        local tune = receiver.Config.Tune
                                        tune.Recoil_X = 0; tune.Recoil_Z = 0; tune.Recoil_Camera = 0
                                        tune.RecoilForce_Tap = 0; tune.RecoilForce_Impulse = 0
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end,
})

-- [[ LOGIC HỆ THỐNG ]] --

local function isValidNPC(model)
    if not model:IsA("Model") or Players:GetPlayerFromCharacter(model) then return false end
    return table.find(TARGET_NAMES, model.Name) ~= nil
end

local function getESPColor(modelName)
    return (modelName == "Zombie") and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 255, 0)
end

RunService.RenderStepped:Connect(function()
    -- FOV
    fovCircle.Visible = getgenv().TokaiSettings.FOVEnabled and getgenv().TokaiSettings.AimEnabled
    fovCircle.Radius = getgenv().TokaiSettings.FOVRadius
    fovCircle.Position = UserInputService:GetMouseLocation()

    -- Loop NPC
    for _, npc in ipairs(Workspace:GetChildren()) do
        if isValidNPC(npc) then
            local head = npc:FindFirstChild("Head")
            if head then
                -- ESP
                local box = head:FindFirstChild("Wall_Box")
                if not box then
                    local newBox = Instance.new("BoxHandleAdornment")
                    newBox.Name = "Wall_Box"
                    newBox.Size = head.Size + Vector3.new(0.2, 0.2, 0.2)
                    newBox.Adornee = head
                    newBox.AlwaysOnTop = true
                    newBox.ZIndex = 5
                    newBox.Color3 = getESPColor(npc.Name)
                    newBox.Transparency = getgenv().TokaiSettings.WallEnabled and 0.4 or 1
                    newBox.Parent = head
                else
                    box.Transparency = getgenv().TokaiSettings.WallEnabled and 0.4 or 1
                end

                -- HITBOX LOGIC
                if getgenv().TokaiSettings.HitboxEnabled then
                    head.Size = Vector3.new(getgenv().TokaiSettings.HitboxSize, getgenv().TokaiSettings.TokaiSettings.HitboxSize, getgenv().TokaiSettings.HitboxSize)
                    head.CanCollide = false
                    head.Transparency = 0.5
                else
                    head.Size = Vector3.new(1.15, 1.15, 1.15)
                    head.Transparency = 0
                end
            end
        end
    end

    -- AIMLOCK
    if getgenv().TokaiSettings.AimEnabled and getgenv().TokaiSettings.HoldingRightClick then
        local target, dist = nil, math.huge
        local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        
        for _, npc in ipairs(Workspace:GetChildren()) do
            if isValidNPC(npc) then
                local h = npc:FindFirstChild("Head")
                if h then
                    local sPos, vis = Camera:WorldToViewportPoint(h.Position)
                    if vis then
                        local m = (Vector2.new(sPos.X, sPos.Y) - center).Magnitude
                        if m < getgenv().TokaiSettings.FOVRadius and m < dist then 
                            dist = m; target = h 
                        end
                    end
                end
            end
        end

        if target then
            local tCF = CFrame.new(Camera.CFrame.Position, target.Position)
            Camera.CFrame = Camera.CFrame:Lerp(tCF, (100 - getgenv().TokaiSettings.Smoothing) / 100 * 0.5)
        end
    end
end)

-- Mouse Event
UserInputService.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton2 then getgenv().TokaiSettings.HoldingRightClick = true end
end)
UserInputService.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton2 then getgenv().TokaiSettings.HoldingRightClick = false end
end)

Rayfield:LoadConfiguration()

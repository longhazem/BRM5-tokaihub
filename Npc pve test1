local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Dịch vụ
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

-- Biến hệ thống
local TARGET_NAMES = {"Male", "npc male", "zombie"} 
local TARGET_PART = "Head"
local LocalPlayer = Players.LocalPlayer

-- State quản lý tính năng
local _G = {
    WallEnabled = false,
    AimEnabled = false,
    HitboxEnabled = false,
    NoRecoilEnabled = false,
    FOVEnabled = false,
    FOVRadius = 100,
    Smoothing = 95,
    HitboxSize = 5,
    HoldingRightClick = false
}

-- FOV Circle
local fovCircle = Drawing.new("Circle")
fovCircle.Color = Color3.fromRGB(0, 255, 0)
fovCircle.Thickness = 2
fovCircle.Filled = false
fovCircle.Visible = false

-- Helper Functions
local function isValidNPC(model)
    if not model:IsA("Model") or Players:GetPlayerFromCharacter(model) then return false end
    return table.find(TARGET_NAMES, model.Name) ~= nil
end

local function getESPColor(modelName)
    return (modelName == "zombie") and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 255, 0)
end

-- Khởi tạo Window
local Window = Rayfield:CreateWindow({
    Name = "TOKAI-HUB-Zaibatsu+RP",
    Icon = 0,
    LoadingTitle = "TOKAI",
    LoadingSubtitle = "by LONGTOKAI",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "TokaiHubBRM5",
        FileName = "Config"
    },
    KeySystem = false
})

-- Tab Chính
local MainTab = Window:CreateTab("Main", 4483362458)
local ESPSection = MainTab:CreateSection("ESP & Visuals")

MainTab:CreateToggle({
    Name = "Enable Wall ESP",
    CurrentValue = false,
    Flag = "WallToggle", 
    Callback = function(Value)
        _G.WallEnabled = Value
    end,
})

MainTab:CreateToggle({
    Name = "Show FOV Circle",
    CurrentValue = false,
    Flag = "FOVToggle",
    Callback = function(Value)
        _G.FOVEnabled = Value
    end,
})

MainTab:CreateSlider({
    Name = "FOV Radius",
    Min = 10,
    Max = 500,
    Default = 100,
    Color = Color3.fromRGB(0, 255, 255),
    Increment = 1,
    ValueName = "Pixels",
    Flag = "FOVRadius",
    Callback = function(Value)
        _G.FOVRadius = Value
    end,
})

local CombatSection = MainTab:CreateSection("Combat Features")

MainTab:CreateToggle({
    Name = "Aimlock (Right Click)",
    CurrentValue = false,
    Flag = "AimToggle",
    Callback = function(Value)
        _G.AimEnabled = Value
    end,
})

MainTab:CreateSlider({
    Name = "Aim Smoothing",
    Min = 0,
    Max = 99,
    Default = 95,
    Color = Color3.fromRGB(255, 255, 255),
    Increment = 1,
    ValueName = "%",
    Flag = "Smoothing",
    Callback = function(Value)
        _G.Smoothing = Value
    end,
})

MainTab:CreateToggle({
    Name = "Hitbox Expander",
    CurrentValue = false,
    Flag = "HitboxToggle",
    Callback = function(Value)
        _G.HitboxEnabled = Value
    end,
})

MainTab:CreateSlider({
    Name = "Hitbox Size",
    Min = 1,
    Max = 25,
    Default = 5,
    Color = Color3.fromRGB(255, 100, 0),
    Increment = 0.5,
    ValueName = "Size",
    Flag = "HSize",
    Callback = function(Value)
        _G.HitboxSize = Value
    end,
})

local MiscTab = Window:CreateTab("Misc", 4483362458)
local WeaponSection = MiscTab:CreateSection("Weapon Mods")

MiscTab:CreateToggle({
    Name = "No Recoil",
    CurrentValue = false,
    Flag = "RecoilToggle",
    Callback = function(Value)
        _G.NoRecoilEnabled = Value
        if Value then
            -- Thực thi No Recoil ngay lập tức khi bật
            local weaponsFolder = game:GetService("ReplicatedStorage"):FindFirstChild("Shared")
                and game:GetService("ReplicatedStorage").Shared:FindFirstChild("Configs")
                and game:GetService("ReplicatedStorage").Shared.Configs:FindFirstChild("Weapon")
                and game:GetService("ReplicatedStorage").Shared.Configs.Weapon:FindFirstChild("Weapons_Player")

            if weaponsFolder then
                for _, platform in pairs(weaponsFolder:GetChildren()) do
                    if platform.Name:match("^Platform_") then
                        for _, weapon in pairs(platform:GetChildren()) do
                            for _, child in pairs(weapon:GetChildren()) do
                                if child:IsA("ModuleScript") and child.Name:match("^Receiver%.") then
                                    local success, receiver = pcall(require, child)
                                    if success and receiver and receiver.Config and receiver.Config.Tune then
                                        local tune = receiver.Config.Tune
                                        tune.Recoil_X = 0; tune.Recoil_Z = 0; tune.RecoilForce_Tap = 0
                                        tune.RecoilForce_Impulse = 0; tune.Recoil_Range = Vector2.zero
                                        tune.Recoil_Camera = 0
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end,
})

-- Logic Xử lý Game
local trackedParts = {}

local function createESP(part, modelName)
    if part:FindFirstChild("Wall_Box") then return end
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Wall_Box"
    box.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
    box.Adornee = part
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Color3 = getESPColor(modelName)
    box.Transparency = _G.WallEnabled and 0.3 or 1
    box.Parent = part
    trackedParts[part] = box
end

local function getClosestNPC()
    local target, dist = nil, math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _, npc in ipairs(Workspace:GetChildren()) do
        if isValidNPC(npc) then
            local head = npc:FindFirstChild("Head")
            if head then
                local screenPos, visible = Camera:WorldToViewportPoint(head.Position)
                if visible then
                    local m = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude
                    if m < _G.FOVRadius and m < dist then dist = m; target = head end
                end
            end
        end
    end
    return target
end

-- Loop Chính
RunService.RenderStepped:Connect(function()
    -- FOV Update
    fovCircle.Visible = _G.FOVEnabled and _G.AimEnabled
    fovCircle.Radius = _G.FOVRadius
    fovCircle.Position = UserInputService:GetMouseLocation()

    -- ESP & Hitbox Update
    for _, npc in ipairs(Workspace:GetChildren()) do
        if isValidNPC(npc) then
            local head = npc:FindFirstChild("Head")
            if head then
                -- ESP
                if not head:FindFirstChild("Wall_Box") then
                    createESP(head, npc.Name)
                else
                    head.Wall_Box.Transparency = _G.WallEnabled and 0.3 or 1
                end
                -- Hitbox
                if _G.HitboxEnabled then
                    head.Size = Vector3.new(_G.HitboxSize, _G.HitboxSize, _G.HitboxSize)
                    head.CanCollide = false
                    head.Transparency = 0.5
                else
                    head.Size = Vector3.new(1.15, 1.15, 1.15) -- Reset size mặc định
                    head.Transparency = 0
                end
            end
        end
    end

    -- Aimlock Update
    if _G.AimEnabled and _G.HoldingRightClick then
        local target = getClosestNPC()
        if target then
            local targetPos = CFrame.new(Camera.CFrame.Position, target.Position)
            Camera.CFrame = Camera.CFrame:Lerp(targetPos, (100 - _G.Smoothing) / 100 * 0.5)
        end
    end
end)

-- Input Events
UserInputService.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton2 then _G.HoldingRightClick = true end
end)
UserInputService.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton2 then _G.HoldingRightClick = false end
end)

Rayfield:LoadConfiguration()

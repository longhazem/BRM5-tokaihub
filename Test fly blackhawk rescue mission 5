--[[ 
    --uhsh--
    SỐ THỨ TỰ: 03 (Bản nâng cấp Raycast)
    CHỨC NĂNG: TẠO ĐẾ CHÂN KHÔNG TRƯỢT
    --uhsh--
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- --- CẤU HÌNH ---
local isEnabled = false
local PLATFORM_COLOR = Color3.fromRGB(0, 255, 255)
local PLATFORM_SIZE = Vector3.new(7, 0.8, 7) -- Làm to hơn một chút để dễ đứng
local OFFSET_Y = 3.5 -- Độ cao mặc định dưới HRP

-- --- GIAO DIỆN ---
local sg = Instance.new("ScreenGui")
sg.Name = "PlatformSystem"
sg.DisplayOrder = 1000
sg.IgnoreGuiInset = true
sg.Parent = pGui

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 180, 0, 50)
btn.Position = UDim2.new(0.5, -90, 0.05, 0)
btn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
btn.BorderSizePixel = 2
btn.BorderColor3 = Color3.fromRGB(255, 255, 255)
btn.Text = "PLATFORM: OFF"
btn.TextColor3 = Color3.fromRGB(255, 80, 80)
btn.Font = Enum.Font.GothamBlack
btn.TextSize = 18
btn.Parent = sg

Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)

btn.MouseButton1Click:Connect(function()
	isEnabled = not isEnabled
	btn.Text = isEnabled and "PLATFORM: ON" or "PLATFORM: OFF"
	btn.TextColor3 = isEnabled and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 80, 80)
	btn.BorderColor3 = isEnabled and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 255, 255)
end)

-- --- HÀM TẠO NỀN TẢNG ---
local function spawnPlatform(pos)
	local part = Instance.new("Part")
	part.Name = "MagicStep"
	part.Size = PLATFORM_SIZE
	part.Position = pos
	part.Anchored = true
	part.CanCollide = true
	part.Material = Enum.Material.Neon
	part.Color = PLATFORM_COLOR
	part.Transparency = 0.4
	part.TopSurface = Enum.SurfaceType.Smooth
	part.BottomSurface = Enum.SurfaceType.Smooth
	
	-- Cho vào workspace ngay lập tức
	part.Parent = game.Workspace
	
	-- Hiệu ứng xóa mượt
	task.delay(0.5, function()
		local tween = TweenService:Create(part, TweenInfo.new(0.3), {
			Transparency = 1,
			Size = Vector3.new(0, 0, 0)
		})
		tween:Play()
		tween.Completed:Connect(function()
			part:Destroy()
		end)
	end)
end

-- --- VÒNG LẶP CHÍNH ---
RunService.Heartbeat:Connect(function()
	if not isEnabled then return end
	
	local char = player.Character
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	
	if hrp and hum then
		-- Tạo điểm spawn dựa trên vị trí hiện tại
		-- Chúng ta trừ đi một khoảng đủ để chân đứng lên
		local spawnPos = hrp.Position - Vector3.new(0, OFFSET_Y, 0)
		
		-- Chỉ tạo khi chưa có tấm nào ở ngay dưới (tránh spam quá nhiều làm lag)
		local region = Region3.new(spawnPos - Vector3.new(1,1,1), spawnPos + Vector3.new(1,1,1))
		local partsInRegion = workspace:FindPartsInRegion3(region, nil, 10)
		
		local found = false
		for _, p in pairs(partsInRegion) do
			if p.Name == "MagicStep" then
				found = true
				break
			end
		end
		
		if not found then
			spawnPlatform(spawnPos)
		end
	end
end)

-- --uhsh-- KẾT THÚC --uhsh--

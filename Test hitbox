-- Clears the console output before starting the script
print("Starting script with Head Hitbox...")
if typeof(clear) == "function" then clear() end

-- SERVICES: Getting the basic tools from Roblox to interact with the game
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- SETTINGS & VARIABLES
local localPlayer = Players.LocalPlayer

local TARGET_HITBOX_SIZE = Vector3.new(15, 15, 15) -- Kích thước hitbox mới cho đầu

local activeNPCs = {}      -- List of enemies currently in the game
local originalSizes = {}   -- Storage for original sizes to restore them later
local wallConnections = {} -- List of technical connections to clean up later

-- TOGGLES
local silentEnabled = true     
local showHitbox = false       

--- HELPER FUNCTIONS ---

-- Checks if the model is an AI/NPC enemy
local function hasAIChild(model)
    for _, c in ipairs(model:GetChildren()) do
        if type(c.Name) == "string" and c.Name:sub(1, 3) == "AI_" then return true end
    end
    return false
end

-- Makes the NPC HEAD larger
local function applySilentHitbox(model, head)
    if not originalSizes[head] then originalSizes[head] = head.Size end
    head.Size = TARGET_HITBOX_SIZE
    head.Transparency = showHitbox and 0.85 or 0 -- Giữ hiển thị hoặc tàng hình tùy showHitbox
    head.CanCollide = true
end

-- Restores head to its normal size
local function restoreOriginalSize(head)
    if head and originalSizes[head] then
        head.Size = originalSizes[head]
        head.Transparency = 0
        head.CanCollide = true -- Mặc định của Head thường là true
    end
    originalSizes[head] = nil
end

-- Adds an enemy to our tracking list
local function addNPC(model)
    if activeNPCs[model] or model.Name ~= "Male" or not hasAIChild(model) then return end
    local head = model:FindFirstChild("Head")
    if not head then return end
    activeNPCs[model] = { head = head }
end

--- MAIN GAME LOOPS ---

-- Detect NPCs already in game
for _, m in ipairs(Workspace:GetChildren()) do
    if m:IsA("Model") and m.Name == "Male" then if hasAIChild(m) then addNPC(m) end end
end

-- Detect new NPCs when they spawn
table.insert(wallConnections, Workspace.ChildAdded:Connect(function(m)
    if m:IsA("Model") and m.Name == "Male" then 
        task.delay(0.2, function() if hasAIChild(m) then addNPC(m) end end) 
    end
end))

-- Continuous loop for Hitbox checks
RunService.RenderStepped:Connect(function()
    for m, d in pairs(activeNPCs) do
        -- Apply larger hitboxes TO HEAD if enabled
        if silentEnabled and d.head then 
            applySilentHitbox(m, d.head) 
        end
    end
end)

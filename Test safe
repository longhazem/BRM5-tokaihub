-- [TOKAI HUB - FINAL VERSION WITH TOGGLE BUTTON]
print("Loading Tokai Hub with Toggle Button...")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local lighting = game:GetService("Lighting")

-- SETTINGS
local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local TARGET_HITBOX_SIZE = Vector3.new(15, 15, 15)

local activeNPCs = {}
local trackedParts = {}
local originalSizes = {}
local wallEnabled = false
local silentEnabled = false
local fullBrightEnabled = false
local isUnloaded = false

local visibleColor = Color3.fromRGB(0, 255, 0)
local hiddenColor = Color3.fromRGB(255, 0, 0)

-- [CLEANUP]
local function Cleanup()
    local old = (gethui and gethui():FindFirstChild("TOKAI_V8")) or game.CoreGui:FindFirstChild("TOKAI_V8")
    if old then old:Destroy() end
end
Cleanup()

-- [GUI SETUP]
local sg = Instance.new("ScreenGui")
sg.Name = "TOKAI_V8"
sg.Parent = (gethui and gethui()) or game.CoreGui
sg.ResetOnSpawn = false
sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- [MAIN FRAME]
local main = Instance.new("Frame", sg)
main.Name = "MainFrame"
main.Size = UDim2.new(0, 500, 0, 320)
main.Position = UDim2.new(0.5, -250, 0.5, -160)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
main.BorderSizePixel = 0
main.Active = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 8)

-- [TOGGLE BUTTON - NÚT MỞ MENU]
local openBtn = Instance.new("TextButton", sg)
openBtn.Name = "OpenButton"
openBtn.Size = UDim2.new(0, 50, 0, 50)
openBtn.Position = UDim2.new(0, 20, 0.5, -25)
openBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
openBtn.Text = "T" -- Chữ T đại diện cho Tokai
openBtn.TextColor3 = Color3.fromRGB(255, 245, 150)
openBtn.Font = "GothamBold"
openBtn.TextSize = 20
openBtn.Visible = false -- Ẩn khi menu đang mở
Instance.new("UICorner", openBtn).CornerRadius = UDim.new(1, 0)
local openStroke = Instance.new("UIStroke", openBtn)
openStroke.Thickness = 2
openStroke.Color = Color3.fromRGB(255, 245, 150)

-- [DRAG LOGIC - KÉO MENU]
local dragging, dragInput, dragStart, startPos
local function updateDrag(input)
    local delta = input.Position - dragStart
    main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = main.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        updateDrag(input)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- [CLOSE LOGIC]
local function toggleUI()
    local isVisible = main.Visible
    main.Visible = not isVisible
    openBtn.Visible = isVisible -- Hiện nút tròn khi Menu ẩn và ngược lại
end

openBtn.MouseButton1Click:Connect(toggleUI)

-- [SIDEBAR]
local sidebar = Instance.new("Frame", main)
sidebar.Size = UDim2.new(0, 130, 1, 0)
sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
sidebar.BorderSizePixel = 0
Instance.new("UICorner", sidebar).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel", sidebar)
title.Size = UDim2.new(1, 0, 0, 40)
title.Text = "TOKAI HUB"
title.TextColor3 = Color3.fromRGB(255, 245, 150)
title.Font = "GothamBold"
title.TextSize = 14
title.BackgroundTransparency = 1

local tabList = Instance.new("ScrollingFrame", sidebar)
tabList.Size = UDim2.new(1, 0, 1, -50)
tabList.Position = UDim2.new(0, 0, 0, 40)
tabList.BackgroundTransparency = 1
tabList.ScrollBarThickness = 0
local layout = Instance.new("UIListLayout", tabList)
layout.Padding = UDim.new(0, 5)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local pages = Instance.new("Frame", main)
pages.Size = UDim2.new(1, -140, 1, -20)
pages.Position = UDim2.new(0, 135, 0, 10)
pages.BackgroundTransparency = 1

-- [BUILDER FUNCTIONS]
local function CreateTab(name, isFirst)
    local page = Instance.new("ScrollingFrame", pages)
    page.Size = UDim2.new(1, 0, 1, 0)
    page.Visible = isFirst or false
    page.BackgroundTransparency = 1
    page.ScrollBarThickness = 2
    Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

    local btn = Instance.new("TextButton", tabList)
    btn.Size = UDim2.new(0, 110, 0, 35)
    btn.BackgroundColor3 = isFirst and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(25, 25, 25)
    btn.Text = name
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = "GothamSemibold"
    btn.TextSize = 12
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        for _, p in pairs(pages:GetChildren()) do if p:IsA("ScrollingFrame") then p.Visible = false end end
        for _, b in pairs(tabList:GetChildren()) do if b:IsA("TextButton") then b.BackgroundColor3 = Color3.fromRGB(25, 25, 25) end end
        page.Visible = true
        btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    end)

    local items = {}
    function items:AddToggle(text, callback)
        local tgl = Instance.new("TextButton", page)
        tgl.Size = UDim2.new(1, -10, 0, 40)
        tgl.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        tgl.Text = "  " .. text
        tgl.TextColor3 = Color3.new(1, 1, 1)
        tgl.TextXAlignment = "Left"
        tgl.Font = "Gotham"
        tgl.TextSize = 13
        Instance.new("UICorner", tgl)
        
        local state = false
        tgl.MouseButton1Click:Connect(function()
            state = not state
            tgl.BackgroundColor3 = state and Color3.fromRGB(255, 245, 150) or Color3.fromRGB(30, 30, 30)
            tgl.TextColor3 = state and Color3.new(0,0,0) or Color3.new(1,1,1)
            callback(state)
        end)
    end
    
    function items:AddButton(text, callback)
        local b = Instance.new("TextButton", page)
        b.Size = UDim2.new(1, -10, 0, 40)
        b.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        b.Text = text; b.TextColor3 = Color3.new(1,1,1)
        Instance.new("UICorner", b)
        b.MouseButton1Click:Connect(callback)
    end

    return items
end

-- [TABS DEFINITION]
local combat = CreateTab("Combat", true)
combat:AddToggle("Silent Hitbox", function(v) silentEnabled = v end)

local visual = CreateTab("Visuals", false)
visual:AddToggle("ESP Wallhack", function(v)
    wallEnabled = v
    if not v then
        for part, _ in pairs(trackedParts) do
            if part and part:FindFirstChild("Wall_Box") then part.Wall_Box:Destroy() end
        end
        trackedParts = {}
    end
end)
visual:AddToggle("FullBright", function(v) fullBrightEnabled = v end)

local settings = CreateTab("Settings", false)
settings:AddButton("Close Menu", toggleUI)
settings:AddButton("Unload Script", function()
    isUnloaded = true
    sg:Destroy()
end)

-- [GAME LOGIC]
local function isValidNPC(m)
    return (m:IsA("Model") and (m.Name == "Male" or m.Name == "Zombie"))
end

local function addNPC(m)
    local root = m:FindFirstChild("HumanoidRootPart") or m:FindFirstChild("Root")
    local head = m:FindFirstChild("Head")
    if root and head then
        activeNPCs[m] = {root = root, head = head}
    end
end

Workspace.ChildAdded:Connect(function(m)
    task.wait(0.5)
    if isValidNPC(m) then addNPC(m) end
end)

for _, m in pairs(Workspace:GetChildren()) do if isValidNPC(m) then addNPC(m) end end

RunService.RenderStepped:Connect(function()
    if isUnloaded then return end
    
    if fullBrightEnabled then
        lighting.Brightness = 2
        lighting.ClockTime = 12
    end

    for m, d in pairs(activeNPCs) do
        if not m.Parent then activeNPCs[m] = nil continue end
        
        -- ESP Logic
        if wallEnabled and d.head then
            if not d.head:FindFirstChild("Wall_Box") then
                local box = Instance.new("BoxHandleAdornment", d.head)
                box.Name = "Wall_Box"
                box.Size = d.head.Size + Vector3.new(0.2, 0.2, 0.2)
                box.Adornee = d.head
                box.AlwaysOnTop = true
                box.ZIndex = 5
                box.Transparency = 0.5
                trackedParts[d.head] = true
            end
            
            -- Raycast color check
            local origin = camera.CFrame.Position
            local ray = Workspace:Raycast(origin, d.head.Position - origin, RaycastParams.new())
            d.head.Wall_Box.Color3 = (not ray) and visibleColor or hiddenColor
        end

        -- Silent Hitbox
        if silentEnabled and d.root then
            if not originalSizes[m] then originalSizes[m] = d.root.Size end
            d.root.Size = TARGET_HITBOX_SIZE
            d.root.CanCollide = true
        elseif originalSizes[m] then
            d.root.Size = originalSizes[m]
            originalSizes[m] = nil
        end
    end
end)

-- Toggle bằng phím
UserInputService.InputBegan:Connect(function(i, gp)
    if not gp and i.KeyCode == Enum.KeyCode.Insert then toggleUI() end
end)

-- [TOKAI HUB FIXED - REPAIRED INTERACTION]
print("Fixing UI Interaction issues...")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local RS = game:GetService("ReplicatedStorage")
local lighting = game:GetService("Lighting")

-- SETTINGS
local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local TARGET_HITBOX_SIZE = Vector3.new(15, 15, 15)

local activeNPCs = {}
local trackedParts = {}
local originalSizes = {}
local wallConnections = {}

local wallEnabled = false
local silentEnabled = false
local showHitbox = false
local fullBrightEnabled = false
local isUnloaded = false
local patchOptions = { recoil = false, firemodes = false }

local visibleColor = Color3.fromRGB(0, 255, 0)
local hiddenColor = Color3.fromRGB(255, 0, 0)

local originalLighting = {
    Brightness = lighting.Brightness,
    ClockTime = lighting.ClockTime,
    FogEnd = lighting.FogEnd,
    GlobalShadows = lighting.GlobalShadows,
    Ambient = lighting.Ambient
}

-- [LOGIC FUNCTIONS]
local function getRootPart(model)
    return model:FindFirstChild("Root") or model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("UpperTorso")
end

local function isValidNPC(model)
    local name = model.Name:lower()
    if name == "male" or name == "zombie" or name == "zombies" then
        if name == "male" then
            for _, c in ipairs(model:GetChildren()) do
                if type(c.Name) == "string" and c.Name:sub(1, 3) == "AI_" then return true end
            end
            return false
        end
        return true
    end
    return false
end

local function createBoxForPart(part)
    if not part or part:FindFirstChild("Wall_Box") then return end
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "Wall_Box"
    box.Size = part.Size + Vector3.new(0.2, 0.2, 0.2)
    box.Adornee = part
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Transparency = 0.3
    box.Parent = part
    trackedParts[part] = true
end

local function destroyAllBoxes()
    for part, _ in pairs(trackedParts) do
        if part and part:FindFirstChild("Wall_Box") then pcall(function() part.Wall_Box:Destroy() end) end
    end
    trackedParts = {}
end

local function applySilentHitbox(model, root)
    if not originalSizes[model] then originalSizes[model] = root.Size end
    root.Size = TARGET_HITBOX_SIZE
    root.Transparency = showHitbox and 0.85 or 1
    root.CanCollide = true
end

local function restoreOriginalSize(model)
    local root = getRootPart(model)
    if root and originalSizes[model] then
        root.Size = originalSizes[model]
        root.Transparency = 1
        root.CanCollide = false
    end
    originalSizes[model] = nil
end

local function addNPC(model)
    if activeNPCs[model] or not isValidNPC(model) then return end
    local head = model:FindFirstChild("Head") or getRootPart(model)
    local root = getRootPart(model)
    if not (head and root) then return end
    activeNPCs[model] = { head = head, root = root }
    if wallEnabled then createBoxForPart(head) end
end

-- [GUI SYSTEM]
local function CleanupUI()
    local old = (gethui and gethui():FindFirstChild("TOKAI_FIXED")) or game.CoreGui:FindFirstChild("TOKAI_FIXED")
    if old then old:Destroy() end
end
CleanupUI()

local function MakeDraggable(frame, dragHandle)
    local dragging, dragInput, dragStart, startPos
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
end

local Library = {}
function Library:CreateWindow()
    local sg = Instance.new("ScreenGui")
    sg.Name = "TOKAI_FIXED"
    sg.Parent = (gethui and gethui()) or game.CoreGui
    sg.DisplayOrder = 100

    local main = Instance.new("Frame", sg)
    main.Name = "Main"
    main.Size = UDim2.new(0, 520, 0, 340)
    main.Position = UDim2.new(0.5, -260, 0.5, -170)
    main.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
    main.BorderSizePixel = 0
    main.Active = true -- Rất quan trọng để chặn input xuyên thấu
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 10)
    local stroke = Instance.new("UIStroke", main)
    stroke.Thickness = 2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    local sidebar = Instance.new("Frame", main)
    sidebar.Size = UDim2.new(0, 140, 1, 0)
    sidebar.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
    sidebar.BorderSizePixel = 0
    Instance.new("UICorner", sidebar).CornerRadius = UDim.new(0, 10)

    local tabContainer = Instance.new("ScrollingFrame", sidebar)
    tabContainer.Size = UDim2.new(1, 0, 1, -60)
    tabContainer.Position = UDim2.new(0, 0, 0, 50)
    tabContainer.BackgroundTransparency = 1
    tabContainer.ScrollBarThickness = 0
    local tabLayout = Instance.new("UIListLayout", tabContainer)
    tabLayout.Padding = UDim.new(0, 5)
    tabLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    local pages = Instance.new("Frame", main)
    pages.Size = UDim2.new(1, -160, 1, -20)
    pages.Position = UDim2.new(0, 150, 0, 10)
    pages.BackgroundTransparency = 1

    local first = true
    function Library:CreateTab(name)
        local page = Instance.new("ScrollingFrame", pages)
        page.Size = UDim2.new(1, 0, 1, 0)
        page.Visible = false
        page.BackgroundTransparency = 1
        page.ScrollBarThickness = 2
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

        local btn = Instance.new("TextButton", tabContainer)
        btn.Size = UDim2.new(0, 120, 0, 32)
        btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        btn.Text = name
        btn.TextColor3 = Color3.fromRGB(200, 200, 200)
        btn.Font = "GothamSemibold"
        btn.TextSize = 12
        Instance.new("UICorner", btn)

        btn.MouseButton1Click:Connect(function()
            for _, p in pairs(pages:GetChildren()) do if p:IsA("ScrollingFrame") then p.Visible = false end end
            for _, b in pairs(tabContainer:GetChildren()) do if b:IsA("TextButton") then b.BackgroundColor3 = Color3.fromRGB(30, 30, 30) end end
            page.Visible = true
            btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        end)

        if first then page.Visible = true; btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60); first = false end

        local elements = {}
        function elements:AddToggle(text, callback)
            local tgl = Instance.new("TextButton", page)
            tgl.Size = UDim2.new(1, -10, 0, 38)
            tgl.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
            tgl.Text = "  " .. text
            tgl.TextColor3 = Color3.new(1, 1, 1)
            tgl.TextXAlignment = "Left"
            tgl.Font = "Gotham"
            tgl.TextSize = 13
            Instance.new("UICorner", tgl)
            local state = false
            tgl.MouseButton1Click:Connect(function()
                state = not state
                tgl.BackgroundColor3 = state and Color3.fromRGB(100, 100, 255) or Color3.fromRGB(28, 28, 28)
                callback(state)
            end)
        end

        function elements:AddSlider(text, min, max, init, callback)
            local sFrame = Instance.new("Frame", page)
            sFrame.Size = UDim2.new(1, -10, 0, 45)
            sFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
            Instance.new("UICorner", sFrame)
            local lbl = Instance.new("TextLabel", sFrame)
            lbl.Text = "  " .. text .. ": " .. init; lbl.Size = UDim2.new(1, 0, 0, 20)
            lbl.TextColor3 = Color3.new(1, 1, 1); lbl.BackgroundTransparency = 1; lbl.TextXAlignment = "Left"; lbl.Font = "Gotham"; lbl.TextSize = 12
            local bar = Instance.new("Frame", sFrame)
            bar.Size = UDim2.new(0.9, 0, 0, 6); bar.Position = UDim2.new(0.05, 0, 0.7, 0); bar.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            local fill = Instance.new("Frame", bar); fill.Size = UDim2.new((init-min)/(max-min), 0, 1, 0); fill.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
            local dragging = false
            local function update()
                local p = math.clamp((UserInputService:GetMouseLocation().X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
                local val = math.floor(min + (p * (max - min)))
                fill.Size = UDim2.new(p, 0, 1, 0); lbl.Text = "  " .. text .. ": " .. val; callback(val)
            end
            bar.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true update() end end)
            UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
            RunService.RenderStepped:Connect(function() if dragging then update() end end)
        end
        return elements
    end

    MakeDraggable(main, sidebar)

    task.spawn(function()
        local h = 0
        while sg.Parent do
            h = h + 1/300; stroke.Color = Color3.fromHSV(h%1, 0.7, 1)
            RunService.RenderStepped:Wait()
        end
    end)
    return Library, sg
end

-- INITIALIZE
local win, root = Library:CreateWindow()
local combat = win:CreateTab("Combat")
combat:AddToggle("Silent Hitbox", function(v) silentEnabled = v end)

local visual = win:CreateTab("Visuals")
visual:AddToggle("ESP Raycast", function(v)
    wallEnabled = v
    if v then for _, d in pairs(activeNPCs) do createBoxForPart(d.head) end else destroyAllBoxes() end
end)
visual:AddToggle("FullBright", function(v)
    fullBrightEnabled = v
    if not v then for p, val in pairs(originalLighting) do lighting[p] = val end end
end)

local colors = win:CreateTab("Colors")
colors:AddSlider("Visible R", 0, 255, 0, function(v) visibleColor = Color3.fromRGB(v, visibleColor.G * 255, visibleColor.B * 255) end)
colors:AddSlider("Visible G", 0, 255, 255, function(v) visibleColor = Color3.fromRGB(visibleColor.R * 255, v, visibleColor.B * 255) end)

-- DETECTION
for _, m in ipairs(Workspace:GetChildren()) do if m:IsA("Model") and isValidNPC(m) then addNPC(m) end end
Workspace.ChildAdded:Connect(function(m) if m:IsA("Model") then task.wait(0.5); addNPC(m) end end)

-- RUNNER
RunService.RenderStepped:Connect(function()
    if isUnloaded then return end
    if fullBrightEnabled then
        lighting.Brightness = 2; lighting.ClockTime = 12; lighting.Ambient = Color3.new(1, 1, 1)
    end
    for m, d in pairs(activeNPCs) do
        if not m.Parent then activeNPCs[m] = nil continue end
        if wallEnabled and d.head and d.head:FindFirstChild("Wall_Box") then
            local origin = camera.CFrame.Position
            local rp = RaycastParams.new()
            rp.FilterType = Enum.RaycastFilterType.Blacklist
            rp.FilterDescendantsInstances = {localPlayer.Character, d.head, m}
            local r = Workspace:Raycast(origin, d.head.Position - origin, rp)
            d.head.Wall_Box.Color3 = (not r) and visibleColor or hiddenColor
        end
        if silentEnabled then applySilentHitbox(m, d.root) end
    end
end)

UserInputService.InputBegan:Connect(function(i, gp)
    if not gp and i.KeyCode == Enum.KeyCode.Insert then root.Enabled = not root.Enabled end
end)
